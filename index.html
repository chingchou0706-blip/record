<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>智慧記帳</title>

  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="智慧記帳">

  <link rel="manifest" href="./manifest.webmanifest">

  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { box-sizing: border-box; }
    .fade-in { animation: fadeIn .25s ease-out; }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(6px); }
      to { opacity:1; transform:none; }
    }
  </style>
</head>

<body class="h-full bg-black">
<div id="app" class="h-full w-full overflow-hidden" style="background:linear-gradient(135deg,#667eea,#764ba2)">

<!-- ========== MAIN ========== -->
<div id="main-screen" class="h-full flex flex-col">
  <header class="px-6 pt-12 pb-6 text-white">
    <h1 class="text-3xl font-bold">智慧記帳</h1>
    <div class="mt-2 text-4xl font-bold">
      NT$ <span id="total-amount">0</span>
    </div>
    <p class="text-sm opacity-75">本月總支出</p>
  </header>

  <div class="px-6 mb-4">
    <button id="quick-expense-btn" class="w-full py-4 rounded-2xl bg-white bg-opacity-25 text-white font-semibold text-lg">
      ➕ 快速記一筆
    </button>
  </div>

  <div class="flex-1 bg-gray-50 rounded-t-3xl px-6 py-6 overflow-auto">
    <h2 class="font-bold mb-3">最近記錄</h2>
    <div id="recent-records" class="space-y-2"></div>
  </div>
</div>

<!-- ========== STEP 1 ========== -->
<div id="step1-screen" class="h-full hidden flex-col">
  <header class="px-6 pt-12 pb-6 text-white">
    <button onclick="showScreen('main-screen')">←</button>
    <h1 class="text-2xl font-bold mt-4">選擇分類</h1>
  </header>

  <div class="flex-1 bg-gray-50 rounded-t-3xl px-6 py-6">
    <div id="category-grid" class="grid grid-cols-3 gap-4"></div>
  </div>
</div>

<!-- ========== STEP 3 ========== -->
<div id="step3-screen" class="h-full hidden flex-col">
  <header class="px-6 pt-12 pb-6 text-white">
    <button onclick="showScreen('step1-screen')">←</button>
    <h1 class="text-2xl font-bold mt-4">支付方式</h1>
  </header>

  <div class="flex-1 bg-gray-50 rounded-t-3xl px-6 py-6 space-y-3">
    <button class="pay-btn" data-method="LINE Pay" data-link="line://pay/generateQR">LINE Pay</button>
    <button class="pay-btn" data-method="街口支付" data-link="jkos://showQRCode">街口支付</button>
    <button class="pay-btn" data-method="悠遊付" data-link="tw.com.easycard.easycardwallet://paymentCode">悠遊付</button>
    <button class="pay-btn" data-method="現金">現金</button>
  </div>
</div>

<!-- ========== STEP 4 (CASH) ========== -->
<div id="step4-screen" class="h-full hidden flex-col">
  <header class="px-6 pt-12 pb-6 text-white">
    <button onclick="showScreen('step3-screen')">←</button>
    <h1 class="text-2xl font-bold mt-4">輸入金額</h1>
  </header>

  <div class="flex-1 bg-gray-50 rounded-t-3xl px-6 py-6 flex flex-col">
    <input id="amount-input" type="number" class="text-5xl text-center mb-6 bg-transparent outline-none" placeholder="0" />
    <button id="save-expense-btn" class="mt-auto py-4 rounded-xl bg-indigo-500 text-white font-bold">
      儲存
    </button>
  </div>
</div>

</div>

<script>
const screens = ["main-screen","step1-screen","step3-screen","step4-screen"];
function showScreen(id){
  screens.forEach(s=>{
    const el=document.getElementById(s);
    el.classList.toggle("hidden", s!==id);
    if(s===id) el.classList.add("fade-in");
  });
}

let current = { category:"", method:"" };
const categories=["早餐","午餐","晚餐","交通","娛樂","購物"];

function renderCategories(){
  const g=document.getElementById("category-grid");
  g.innerHTML=categories.map(c=>`
    <button class="p-4 bg-white rounded-xl" onclick="selectCategory('${c}')">${c}</button>
  `).join("");
}

function selectCategory(c){
  current.category=c;
  showScreen("step3-screen");
}

document.getElementById("quick-expense-btn").onclick=()=>{
  renderCategories();
  showScreen("step1-screen");
};

document.querySelectorAll(".pay-btn").forEach(b=>{
  b.onclick=()=>{
    current.method=b.dataset.method;
    if(current.method==="現金"){
      showScreen("step4-screen");
    }else{
      location.href=b.dataset.link;
      setTimeout(()=>showScreen("step4-screen"),1200);
    }
  };
});

document.getElementById("save-expense-btn").onclick=async()=>{
  const amount=Number(amount-input.value);
  if(!amount) return;

  await window.dataSdk.create({
    id:Date.now().toString(),
    category:current.category,
    amount,
    payment_method:current.method,
    timestamp:new Date().toISOString()
  });

  amount-input.value="";
  showScreen("main-screen");
};

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}

window.dataSdk?.init({
  onDataChanged(data){
    document.getElementById("total-amount").textContent =
      data.reduce((s,r)=>s+r.amount,0).toLocaleString();

    document.getElementById("recent-records").innerHTML =
      data.slice(0,10).map(r=>`
        <div class="bg-white p-3 rounded-lg flex justify-between">
          <span>${r.category}</span>
          <span>NT$ ${r.amount}</span>
        </div>
      `).join("");
  }
});
</script>
</body>
</html>
