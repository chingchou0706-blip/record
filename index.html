<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#667eea">
  <title>æ™ºæ…§è¨˜å¸³APP - Deep Linkç‰ˆ</title>

  <link rel="manifest" href="manifest.webmanifest">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { box-sizing: border-box; }
    .fade-in { animation: fadeIn 0.25s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0);} }
    .pulse-ring { animation: pulseRing 1.5s ease-out infinite; }
    @keyframes pulseRing { 0% { transform: scale(0.95); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
    .safe-pad { padding-bottom: env(safe-area-inset-bottom); }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>

<body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div id="main-screen" class="h-full flex flex-col">
      <header class="px-6 pt-8 pb-6">
        <div class="flex items-center justify-between mb-2">
          <h1 id="app-title" class="text-white text-3xl font-bold">æ™ºæ…§è¨˜å¸³</h1>
          <button id="settings-btn" class="text-white text-2xl w-10 h-10 flex items-center justify-center rounded-full hover:bg-white hover:bg-opacity-20 transition-all">âš™ï¸</button>
        </div>
        <div class="flex items-baseline gap-2">
          <span id="currency-symbol" class="text-white text-lg opacity-90">NT$</span>
          <span id="total-amount" class="text-white text-4xl font-bold">0</span>
        </div>
        <p class="text-white text-sm opacity-75 mt-1">æœ¬æœˆç¸½æ”¯å‡º</p>
      </header>

      <div class="px-6 mb-6 space-y-3">
        <button id="quick-expense-btn" class="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg" style="background: rgba(255,255,255,0.25); backdrop-filter: blur(10px);">
          <span class="text-2xl mr-2">â•</span> å¿«é€Ÿè¨˜ä¸€ç­†
        </button>
        <button id="analysis-btn" class="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);">
          <span class="text-2xl mr-2">ğŸ“Š</span> æ¶ˆè²»åˆ†æ
        </button>
      </div>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto safe-pad" style="background: #f8f9fa;">
        <section class="mb-6">
          <h2 class="text-lg font-bold mb-3" style="color:#2d3748;">æœ¬æœˆåˆ†é¡æ”¯å‡º</h2>
          <div id="category-stats" class="space-y-2"></div>
        </section>

        <section>
          <h2 class="text-lg font-bold mb-3" style="color:#2d3748;">æœ€è¿‘è¨˜éŒ„</h2>
          <div id="recent-records" class="space-y-2"></div>
        </section>
      </div>
    </div>

    <div id="analysis-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-analysis" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">æ¶ˆè²»åˆ†æ</h1>
        <p class="text-white text-sm opacity-75 mt-1">æª¢è¦–æ‚¨çš„æ¶ˆè²»ç¿’æ…£èˆ‡çµ±è¨ˆ</p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto safe-pad" style="background:#f8f9fa;">
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ“… ç¯©é¸æ¢ä»¶</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">æ™‚é–“å€é–“</label>
              <div class="grid grid-cols-2 gap-2">
                <input type="date" id="filter-start-date" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
                <input type="date" id="filter-end-date" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">æ¶ˆè²»ç”¨é€”</label>
              <select id="filter-category" class="w-full px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
                <option value="all">å…¨éƒ¨ç”¨é€”</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">é‡‘é¡ç¯„åœ</label>
              <div class="grid grid-cols-2 gap-2">
                <input type="number" id="filter-min-amount" placeholder="æœ€ä½é‡‘é¡" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
                <input type="number" id="filter-max-amount" placeholder="æœ€é«˜é‡‘é¡" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
              </div>
            </div>

            <div class="flex gap-2">
              <button id="apply-filter-btn" class="flex-1 py-3 rounded-xl text-white font-semibold" style="background:#667eea;">å¥—ç”¨ç¯©é¸</button>
              <button id="reset-filter-btn" class="px-4 py-3 rounded-xl font-semibold" style="background:#e2e8f0; color:#4a5568;">é‡ç½®</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">ç¸½æ”¯å‡º</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-currency-1">NT$</span><span id="analysis-total">0</span></p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">ç­†æ•¸</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-count">0</span> ç­†</p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">å¹³å‡æ¶ˆè²»</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-currency-2">NT$</span><span id="analysis-average">0</span></p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">æœ€é«˜å–®ç­†</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-currency-3">NT$</span><span id="analysis-max">0</span></p>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ“Š ç”¨é€”åˆ†å¸ƒ</h3>
          <div id="category-distribution" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ’³ æ”¯ä»˜æ–¹å¼</h3>
          <div id="payment-distribution" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ“ æ¶ˆè²»æ˜ç´°</h3>
          <div id="analysis-records" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <div id="settings-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-settings" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">è¼‰å…·è¨­å®š</h1>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto safe-pad" style="background:#f8f9fa;">
        <div class="bg-white rounded-2xl p-6 shadow-sm mb-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background:#667eea;">ğŸ“±</div>
            <div>
              <h3 class="font-bold text-lg" style="color:#2d3748;">æ‰‹æ©Ÿæ¢ç¢¼è¼‰å…·</h3>
              <p class="text-xs text-gray-500">è¨­å®šå¾Œå°‡è‡ªå‹•é¡¯ç¤ºæ‚¨çš„è¼‰å…·æ¢ç¢¼</p>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-gray-700">è¼‰å…·è™Ÿç¢¼</label>
            <input type="text" id="carrier-number-input" placeholder="ä¾‹å¦‚: /ABC1234" class="w-full px-4 py-3 rounded-xl border-2 text-lg font-mono" style="border-color:#e2e8f0;" maxlength="8">
            <p class="text-xs text-gray-500 mt-2">è«‹è¼¸å…¥å®Œæ•´è¼‰å…·è™Ÿç¢¼ï¼ŒåŒ…å«é–‹é ­çš„ /</p>
          </div>

          <div id="carrier-preview" class="hidden mb-4">
            <p class="text-sm font-semibold mb-2 text-gray-700">é è¦½</p>
            <div class="bg-gray-50 rounded-xl p-4 border-2" style="border-color:#e2e8f0;">
              <div class="bg-white p-4 rounded-lg">
                <svg viewBox="0 0 200 60" class="w-full">
                  <rect x="5" y="5" width="2" height="50" fill="#000"/>
                  <rect x="10" y="5" width="3" height="50" fill="#000"/>
                  <rect x="16" y="5" width="2" height="50" fill="#000"/>
                  <rect x="21" y="5" width="4" height="50" fill="#000"/>
                  <rect x="28" y="5" width="2" height="50" fill="#000"/>
                  <rect x="33" y="5" width="5" height="50" fill="#000"/>
                  <rect x="41" y="5" width="2" height="50" fill="#000"/>
                  <rect x="46" y="5" width="3" height="50" fill="#000"/>
                  <rect x="52" y="5" width="2" height="50" fill="#000"/>
                  <rect x="57" y="5" width="4" height="50" fill="#000"/>
                </svg>
              </div>
              <p class="text-center text-sm font-mono mt-2" id="carrier-preview-text">/ABC1234</p>
            </div>
          </div>

          <button id="save-carrier-btn" class="w-full py-3 rounded-xl text-white font-semibold" style="background:#667eea;">
            <span id="save-carrier-text">å„²å­˜è¼‰å…·è¨­å®š</span>
          </button>
        </div>
      </div>
    </div>

    <div id="step1-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step1" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é¸æ“‡æ¶ˆè²»ç”¨é€”</h1>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto safe-pad" style="background:#f8f9fa;">
        <div id="category-grid" class="grid grid-cols-3 gap-4 mb-6"></div>

        <button id="add-category-btn" class="w-full py-3 rounded-xl border-2 border-dashed text-gray-600 font-semibold" style="border-color:#cbd5e0;">
          <span class="text-xl mr-2">+</span> æ–°å¢åˆ†é¡
        </button>

        <div id="add-category-form" class="mt-4 hidden">
          <input type="text" id="new-category-input" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" class="w-full px-4 py-3 rounded-xl border-2 mb-3" style="border-color:#e2e8f0;">
          <div class="flex gap-2">
            <button id="save-category-btn" class="flex-1 py-3 rounded-xl text-white font-semibold" style="background:#667eea;">å„²å­˜</button>
            <button id="cancel-category-btn" class="flex-1 py-3 rounded-xl font-semibold" style="background:#e2e8f0; color:#4a5568;">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>

    <div id="step2-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step2" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é›»å­ç™¼ç¥¨è¼‰å…·</h1>
        <p class="text-white text-sm opacity-75 mt-1" id="selected-category-display"></p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 flex flex-col safe-pad" style="background:#f8f9fa;">
        <div class="flex-1 flex items-center justify-center mb-6">
          <div class="w-full max-w-sm bg-white rounded-2xl p-8 shadow-lg">
            <div class="text-center mb-4">
              <h3 class="text-lg font-bold mb-2" style="color:#2d3748;">æ‰‹æ©Ÿæ¢ç¢¼è¼‰å…·</h3>
              <p class="text-sm text-gray-500">è«‹å‡ºç¤ºæ­¤æ¢ç¢¼çµ¦åº—å“¡æƒæ</p>
            </div>

            <div class="bg-white p-6 rounded-xl border-2" style="border-color:#e2e8f0;">
              <svg viewBox="0 0 200 80" class="w-full">
                <rect x="5" y="10" width="3" height="60" fill="#000"/>
                <rect x="12" y="10" width="2" height="60" fill="#000"/>
                <rect x="18" y="10" width="4" height="60" fill="#000"/>
                <rect x="26" y="10" width="2" height="60" fill="#000"/>
                <rect x="32" y="10" width="6" height="60" fill="#000"/>
                <rect x="42" y="10" width="2" height="60" fill="#000"/>
                <rect x="48" y="10" width="4" height="60" fill="#000"/>
                <rect x="56" y="10" width="2" height="60" fill="#000"/>
                <rect x="62" y="10" width="3" height="60" fill="#000"/>
                <rect x="69" y="10" width="5" height="60" fill="#000"/>
                <rect x="78" y="10" width="2" height="60" fill="#000"/>
                <rect x="84" y="10" width="4" height="60" fill="#000"/>
                <rect x="92" y="10" width="2" height="60" fill="#000"/>
                <rect x="98" y="10" width="6" height="60" fill="#000"/>
                <rect x="108" y="10" width="3" height="60" fill="#000"/>
                <rect x="115" y="10" width="2" height="60" fill="#000"/>
                <rect x="121" y="10" width="5" height="60" fill="#000"/>
                <rect x="130" y="10" width="2" height="60" fill="#000"/>
                <rect x="136" y="10" width="4" height="60" fill="#000"/>
                <rect x="144" y="10" width="3" height="60" fill="#000"/>
                <rect x="151" y="10" width="2" height="60" fill="#000"/>
                <rect x="157" y="10" width="6" height="60" fill="#000"/>
                <rect x="167" y="10" width="2" height="60" fill="#000"/>
                <rect x="173" y="10" width="4" height="60" fill="#000"/>
                <rect x="181" y="10" width="3" height="60" fill="#000"/>
                <rect x="188" y="10" width="2" height="60" fill="#000"/>
              </svg>
            </div>
            <p class="text-center text-xs text-gray-400 mt-3" id="carrier-display-text">/ABC1234</p>
          </div>
        </div>

        <div class="space-y-3">
          <button id="skip-carrier-btn" class="w-full py-4 rounded-xl font-semibold" style="background:#e2e8f0; color:#4a5568;">è·³éè¼‰å…·ï¼Œç›´æ¥ä»˜æ¬¾</button>
          <button id="continue-to-payment-btn" class="w-full py-4 rounded-xl text-white font-semibold" style="background:#667eea;">ä½¿ç”¨è¼‰å…·å¾Œç¹¼çºŒ</button>
        </div>
      </div>
    </div>

    <div id="step3-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step3" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é¸æ“‡æ”¯ä»˜æ–¹å¼</h1>
        <p class="text-white text-sm opacity-75 mt-1" id="selected-category-display2"></p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto safe-pad" style="background:#f8f9fa;">
        <div class="space-y-3 mb-6">
          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="LINE Pay" data-color="#00B900" data-emoji="ğŸ’š">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#00B900;">ğŸ’š</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">LINE Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="Taiwan Pay" data-color="#0066CC" data-emoji="ğŸ¦">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#0066CC;">ğŸ¦</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">Taiwan Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="å…¨æ”¯ä»˜" data-color="#FF6B00" data-emoji="ğŸ”¶">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#FF6B00;">ğŸ”¶</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">å…¨æ”¯ä»˜ PX Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="è¡—å£æ”¯ä»˜" data-color="#FF3B3B" data-emoji="ğŸª">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#FF3B3B;">ğŸª</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">è¡—å£æ”¯ä»˜</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="æ‚ éŠä»˜" data-color="#0088FF" data-emoji="ğŸš‡">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#0088FF;">ğŸš‡</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">æ‚ éŠä»˜</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="ç¾é‡‘" data-color="#48BB78" data-emoji="ğŸ’µ">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#48BB78;">ğŸ’µ</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">ç¾é‡‘</div>
                <div class="text-xs text-gray-500">æ‰‹å‹•è¼¸å…¥é‡‘é¡</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>
        </div>
      </div>
    </div>

    <div id="payment-redirect-screen" class="h-full flex-col hidden" style="background:#000000;">
      <div class="flex-1 flex items-center justify-center px-6 safe-pad">
        <div class="text-center w-full max-w-md">
          <div class="relative inline-block mb-8">
            <div class="absolute inset-0 w-32 h-32 rounded-full pulse-ring" id="pulse-ring" style="background:rgba(0,185,0,0.3);"></div>
            <div class="w-32 h-32 rounded-3xl mx-auto flex items-center justify-center text-6xl shadow-2xl relative z-10" id="redirect-payment-icon" style="background:#00B900;">ğŸ’š</div>
          </div>

          <h2 class="text-white text-2xl font-bold mb-3" id="redirect-payment-name">LINE Pay</h2>
          <p class="text-white text-lg opacity-75 mb-6">æ­£åœ¨å•Ÿå‹•æ”¯ä»˜ APP...</p>

          <div class="flex justify-center space-x-2 mb-6">
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay:0s;"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay:0.2s;"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay:0.4s;"></div>
          </div>

          <div class="bg-white bg-opacity-10 rounded-2xl p-4 backdrop-blur-lg mx-auto">
            <p class="text-white text-xs opacity-75 mb-2">ğŸ”— Deep Link URL</p>
            <p class="text-white text-xs font-mono break-all opacity-70" id="deep-link-url">twmpshortcut://?type=payment</p>
          </div>

          <div class="mt-6 flex gap-3 justify-center">
            <button id="manual-open-btn" class="px-5 py-3 rounded-xl text-white font-semibold" style="background:rgba(255,255,255,0.18);">å¦‚æœæ²’æœ‰è‡ªå‹•è·³ï¼Œé»æˆ‘æ‰‹å‹•é–‹å•Ÿ</button>
            <button id="cancel-redirect-btn" class="px-5 py-3 rounded-xl text-white font-semibold" style="background:rgba(255,255,255,0.10);">å–æ¶ˆ</button>
          </div>

          <p class="text-white text-xs opacity-40 mt-5">è‹¥ iOS é˜»æ“‹è‡ªå‹•è·³è½‰ï¼Œè«‹æ”¹ç”¨ã€Œæ‰‹å‹•é–‹å•Ÿã€</p>
        </div>
      </div>
    </div>

    <div id="payment-success-screen" class="h-full flex-col hidden">
      <div class="flex-1 flex items-center justify-center px-6 safe-pad" style="background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);">
        <div class="text-center">
          <div class="relative inline-block mb-8">
            <div class="absolute inset-0 w-32 h-32 rounded-full bg-white opacity-20 animate-ping"></div>
            <div class="w-32 h-32 rounded-full mx-auto flex items-center justify-center bg-white shadow-2xl relative z-10"><span class="text-7xl">âœ“</span></div>
          </div>
          <h2 class="text-white text-3xl font-bold mb-3">ä»˜æ¬¾æˆåŠŸï¼</h2>
          <div class="bg-white bg-opacity-20 rounded-2xl px-8 py-5 mb-6 backdrop-blur-lg">
            <p class="text-white text-sm opacity-90 mb-2">å·²ä»˜æ¬¾</p>
            <p class="text-white text-5xl font-bold mb-1"><span id="success-currency">NT$</span><span id="success-amount">0</span></p>
            <p class="text-white text-xs opacity-75 mt-2" id="success-category">æ—©é¤</p>
          </div>
          <div class="mb-6">
            <p class="text-white text-base opacity-90 mb-3">æ­£åœ¨è¿”å›è¨˜å¸³ APP...</p>
            <div class="flex justify-center space-x-2">
              <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay:0.2s;"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay:0.4s;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="step4-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step4" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold" id="step4-title">è¼¸å…¥é‡‘é¡</h1>
        <div class="mt-3 text-white text-sm opacity-90">
          <p>åˆ†é¡: <span id="final-category-display" class="font-semibold"></span></p>
          <p>æ”¯ä»˜: <span id="final-payment-display" class="font-semibold"></span></p>
        </div>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 flex flex-col safe-pad" style="background:#f8f9fa;">
        <div class="flex-1 flex flex-col justify-center mb-6">
          <div class="text-center mb-8">
            <div class="flex items-baseline justify-center">
              <span id="currency-symbol-input" class="text-3xl text-gray-600 mr-2">NT$</span>
              <input type="number" id="amount-input" placeholder="0" class="text-6xl font-bold text-center border-0 outline-none bg-transparent w-full" style="color:#2d3748;" inputmode="decimal">
            </div>
          </div>

          <div class="bg-white rounded-2xl p-4 shadow-sm">
            <label class="block text-sm font-semibold mb-2 text-gray-700">å‚™è¨» (é¸å¡«)</label>
            <textarea id="note-input" placeholder="æ–°å¢å‚™è¨»..." class="w-full px-4 py-3 rounded-xl border-2 resize-none" style="border-color:#e2e8f0;" rows="3"></textarea>
          </div>
        </div>

        <button id="save-expense-btn" class="w-full py-4 rounded-xl text-white font-semibold text-lg shadow-lg" style="background:#667eea;">
          <span id="save-btn-text">å„²å­˜è¨˜éŒ„</span>
        </button>
      </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 hidden items-end justify-center" style="background: rgba(0,0,0,0.45);">
      <div class="w-full max-w-lg bg-white rounded-t-3xl p-6 safe-pad">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold" style="color:#2d3748;">ç·¨è¼¯è¨˜éŒ„</h3>
          <button id="close-edit-modal" class="text-2xl text-gray-400">âœ•</button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold mb-1 text-gray-700">åˆ†é¡</label>
            <input id="edit-category" class="w-full px-4 py-3 rounded-xl border-2" style="border-color:#e2e8f0;" placeholder="ä¾‹å¦‚ï¼šåˆé¤">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-semibold mb-1 text-gray-700">é‡‘é¡</label>
              <input id="edit-amount" type="number" class="w-full px-4 py-3 rounded-xl border-2" style="border-color:#e2e8f0;" placeholder="0">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1 text-gray-700">æ”¯ä»˜æ–¹å¼</label>
              <input id="edit-payment" class="w-full px-4 py-3 rounded-xl border-2" style="border-color:#e2e8f0;" placeholder="ç¾é‡‘ / LINE Pay ...">
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1 text-gray-700">å‚™è¨»</label>
            <textarea id="edit-note" rows="3" class="w-full px-4 py-3 rounded-xl border-2 resize-none" style="border-color:#e2e8f0;" placeholder=""></textarea>
          </div>

          <div class="flex gap-3 pt-2">
            <button id="save-edit-btn" class="flex-1 py-4 rounded-xl text-white font-semibold" style="background:#667eea;">å„²å­˜ä¿®æ”¹</button>
            <button id="cancel-edit-btn" class="flex-1 py-4 rounded-xl font-semibold" style="background:#e2e8f0; color:#4a5568;">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const defaultConfig = { app_title: "æ™ºæ…§è¨˜å¸³", currency_symbol: "NT$" };

  const STORAGE_KEYS = {
    records: "blip_records_v1",
    carrier: "blip_carrier_v1",
    categories: "blip_custom_categories_v1"
  };

  const iosDeepLinks = {
    "LINE Pay": "line://pay/generateQR",
    "Taiwan Pay": "twmpshortcut://?type=payment",
    "å…¨æ”¯ä»˜": "com.pxpay.plus://zjdja",
    "è¡—å£æ”¯ä»˜": "jkos://showQRCode",
    "æ‚ éŠä»˜": "tw.com.easycard.easycardwallet://paymentCode"
  };

  let allRecords = [];
  let carrierSettings = null;

  const defaultCategories = ["æ—©é¤","åˆé¤","æ™šé¤","äº¤é€š","å¨›æ¨‚","è³¼ç‰©","å…¶ä»–"];
  let customCategories = [];

  let currentFlow = {
    category: "",
    paymentMethod: "",
    paymentColor: "",
    paymentEmoji: "",
    carrierUsed: false,
    pendingAmount: 0
  };

  let analysisFilters = { startDate: null, endDate: null, category: "all", minAmount: null, maxAmount: null };

  let editTargetId = null;

  function safeJsonParse(str, fallback) {
    try { return JSON.parse(str); } catch (e) { return fallback; }
  }

  function loadLocal() {
    const rec = safeJsonParse(localStorage.getItem(STORAGE_KEYS.records), []);
    const car = safeJsonParse(localStorage.getItem(STORAGE_KEYS.carrier), null);
    const cats = safeJsonParse(localStorage.getItem(STORAGE_KEYS.categories), []);
    allRecords = Array.isArray(rec) ? rec : [];
    carrierSettings = car && typeof car === "object" ? car : null;
    customCategories = Array.isArray(cats) ? cats : [];
    allRecords.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
  }

  function saveLocal() {
    localStorage.setItem(STORAGE_KEYS.records, JSON.stringify(allRecords));
    localStorage.setItem(STORAGE_KEYS.carrier, JSON.stringify(carrierSettings));
    localStorage.setItem(STORAGE_KEYS.categories, JSON.stringify(customCategories));
  }

  function showSuccessMessage(message) {
    const messageDiv = document.createElement("div");
    messageDiv.textContent = message;
    messageDiv.className = "fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50";
    document.body.appendChild(messageDiv);
    setTimeout(() => messageDiv.remove(), 1800);
  }

  function showErrorMessage(message) {
    const messageDiv = document.createElement("div");
    messageDiv.textContent = message;
    messageDiv.className = "fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50";
    document.body.appendChild(messageDiv);
    setTimeout(() => messageDiv.remove(), 2000);
  }

  function showScreen(screenId) {
    const screens = [
      "main-screen","analysis-screen","settings-screen",
      "step1-screen","step2-screen","step3-screen","step4-screen",
      "payment-redirect-screen","payment-success-screen"
    ];
    screens.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (id === screenId) {
        el.classList.remove("hidden");
        el.classList.add("flex","fade-in");
      } else {
        el.classList.add("hidden");
        el.classList.remove("flex");
      }
    });
  }

  function getCurrency() {
    return defaultConfig.currency_symbol || "NT$";
  }

  function updateCarrierDisplay() {
    if (carrierSettings && carrierSettings.carrier_number) {
      const v = carrierSettings.carrier_number;
      document.getElementById("carrier-display-text").textContent = v;
      document.getElementById("carrier-number-input").value = v;
      document.getElementById("carrier-preview-text").textContent = v;
      document.getElementById("carrier-preview").classList.remove("hidden");
    } else {
      document.getElementById("carrier-display-text").textContent = "/ABC1234";
      document.getElementById("carrier-number-input").value = "";
      document.getElementById("carrier-preview").classList.add("hidden");
    }
  }

  function updateTotalAmount() {
    const total = allRecords.reduce((sum,r)=> sum + (Number(r.amount)||0), 0);
    document.getElementById("total-amount").textContent = total.toLocaleString();
  }

  function updateCategoryStats() {
    const container = document.getElementById("category-stats");
    const totals = {};
    allRecords.forEach(r=>{
      const c = r.category || "å…¶ä»–";
      totals[c] = (totals[c] || 0) + (Number(r.amount)||0);
    });

    const sorted = Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,5);
    if (sorted.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-center py-4">å°šç„¡æ¶ˆè²»è¨˜éŒ„</p>';
      return;
    }

    const maxAmount = Math.max(...sorted.map(x=>x[1]));
    container.innerHTML = sorted.map(([category, amount])=>{
      const pct = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
      return `
        <div class="bg-white rounded-xl p-4 shadow-sm">
          <div class="flex justify-between mb-2">
            <span class="font-semibold" style="color:#2d3748;">${escapeHtml(category)}</span>
            <span class="font-bold" style="color:#667eea;">${getCurrency()}${amount.toLocaleString()}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full" style="width:${pct}%; background:#667eea;"></div>
          </div>
        </div>
      `;
    }).join("");
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function updateRecentRecords() {
    const container = document.getElementById("recent-records");
    const list = allRecords.slice(0, 10);

    if (list.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-center py-4">å°šç„¡æ¶ˆè²»è¨˜éŒ„</p>';
      return;
    }

    container.innerHTML = list.map(r=>{
      const d = new Date(r.timestamp);
      const timeStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      const note = r.note ? `<div class="text-sm text-gray-400 mt-1">${escapeHtml(r.note)}</div>` : "";

      return `
        <div class="bg-white rounded-xl p-4 shadow-sm">
          <div class="flex justify-between items-start gap-3">
            <div class="min-w-0">
              <div class="font-semibold text-lg mb-1 truncate" style="color:#2d3748;">${escapeHtml(r.category || "å…¶ä»–")}</div>
              <div class="text-sm text-gray-500">${escapeHtml(r.payment_method || "ç¾é‡‘")} Â· ${timeStr}</div>
              ${note}
              <div class="mt-3 flex gap-2">
                <button class="edit-btn px-4 py-2 rounded-xl font-semibold" style="background:#edf2f7; color:#2d3748;" data-id="${escapeHtml(r.id)}">ç·¨è¼¯</button>
                <button class="delete-btn px-4 py-2 rounded-xl font-semibold" style="background:#ffe5e5; color:#c53030;" data-id="${escapeHtml(r.id)}">åˆªé™¤</button>
              </div>
            </div>
            <div class="text-xl font-bold shrink-0" style="color:#667eea;">${getCurrency()}${Number(r.amount||0).toLocaleString()}</div>
          </div>
        </div>
      `;
    }).join("");

    container.querySelectorAll(".edit-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> openEditModal(btn.dataset.id));
    });
    container.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.addEventListener("click", ()=> deleteRecord(btn.dataset.id));
    });
  }

  function updateUI() {
    updateTotalAmount();
    updateCategoryStats();
    updateRecentRecords();
  }

  function getCategoryEmoji(category) {
    const map = { "æ—©é¤":"ğŸ³","åˆé¤":"ğŸ±","æ™šé¤":"ğŸ½ï¸","äº¤é€š":"ğŸš—","å¨›æ¨‚":"ğŸ®","è³¼ç‰©":"ğŸ›ï¸","å…¶ä»–":"ğŸ“" };
    return map[category] || "ğŸ’°";
  }

  function renderCategoryGrid() {
    const grid = document.getElementById("category-grid");
    const allCats = [...defaultCategories, ...customCategories];

    grid.innerHTML = allCats.map(c=>`
      <button class="category-btn p-6 rounded-2xl bg-white shadow-sm text-center font-semibold transition-all hover:shadow-md" data-category="${escapeHtml(c)}" style="color:#2d3748;">
        ${getCategoryEmoji(c)}<br><span class="text-sm">${escapeHtml(c)}</span>
      </button>
    `).join("");

    grid.querySelectorAll(".category-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        currentFlow.category = btn.dataset.category;
        document.getElementById("selected-category-display").textContent = `åˆ†é¡: ${currentFlow.category}`;
        document.getElementById("selected-category-display2").textContent = `åˆ†é¡: ${currentFlow.category}`;
        document.getElementById("final-category-display").textContent = currentFlow.category;
        document.getElementById("success-category").textContent = currentFlow.category;
        showScreen("step2-screen");
      });
    });
  }

  function initializeAnalysisFilters() {
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0);

    const fmt = (date)=>{
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,"0");
      const d = String(date.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    };

    document.getElementById("filter-start-date").value = fmt(firstDay);
    document.getElementById("filter-end-date").value = fmt(lastDay);
    document.getElementById("filter-min-amount").value = "";
    document.getElementById("filter-max-amount").value = "";
    document.getElementById("filter-category").value = "all";

    analysisFilters = { startDate: fmt(firstDay), endDate: fmt(lastDay), category:"all", minAmount:null, maxAmount:null };
    updateCategoryFilter();
    performAnalysis();
  }

  function updateCategoryFilter() {
    const select = document.getElementById("filter-category");
    const set = new Set();
    allRecords.forEach(r=>{ if (r.category) set.add(r.category); });

    select.innerHTML = '<option value="all">å…¨éƒ¨ç”¨é€”</option>';
    Array.from(set).sort().forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      select.appendChild(opt);
    });
  }

  function getFilteredRecords() {
    return allRecords.filter(r=>{
      const recordDate = new Date(r.timestamp).toISOString().split("T")[0];

      if (analysisFilters.startDate && recordDate < analysisFilters.startDate) return false;
      if (analysisFilters.endDate && recordDate > analysisFilters.endDate) return false;

      if (analysisFilters.category !== "all" && r.category !== analysisFilters.category) return false;

      const amt = Number(r.amount)||0;
      if (analysisFilters.minAmount !== null && amt < analysisFilters.minAmount) return false;
      if (analysisFilters.maxAmount !== null && amt > analysisFilters.maxAmount) return false;

      return true;
    });
  }

  function performAnalysis() {
    const filtered = getFilteredRecords();
    const total = filtered.reduce((sum,r)=> sum + (Number(r.amount)||0), 0);
    const count = filtered.length;
    const average = count>0 ? Math.round(total/count) : 0;
    const max = count>0 ? Math.max(...filtered.map(r=>Number(r.amount)||0)) : 0;

    document.getElementById("analysis-total").textContent = total.toLocaleString();
    document.getElementById("analysis-count").textContent = count;
    document.getElementById("analysis-average").textContent = average.toLocaleString();
    document.getElementById("analysis-max").textContent = max.toLocaleString();

    const categoryStats = {};
    filtered.forEach(r=>{
      const c = r.category || "å…¶ä»–";
      categoryStats[c] = (categoryStats[c]||0) + (Number(r.amount)||0);
    });

    const catContainer = document.getElementById("category-distribution");
    const sortedCats = Object.entries(categoryStats).sort((a,b)=>b[1]-a[1]);

    if (sortedCats.length === 0) {
      catContainer.innerHTML = '<p class="text-gray-500 text-center py-2">ç„¡è³‡æ–™</p>';
    } else {
      const maxCat = Math.max(...sortedCats.map(x=>x[1]));
      catContainer.innerHTML = sortedCats.map(([c,amt])=>{
        const pct = maxCat>0 ? (amt/maxCat)*100 : 0;
        const proportion = total>0 ? ((amt/total)*100).toFixed(1) : "0.0";
        return `
          <div>
            <div class="flex justify-between mb-1 text-sm">
              <span class="font-semibold" style="color:#2d3748;">${escapeHtml(c)}</span>
              <span class="text-gray-600">${getCurrency()}${amt.toLocaleString()} (${proportion}%)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="h-2 rounded-full" style="width:${pct}%; background:#667eea;"></div>
            </div>
          </div>
        `;
      }).join("");
    }

    const paymentStats = {};
    filtered.forEach(r=>{
      const m = r.payment_method || "ç¾é‡‘";
      if (!paymentStats[m]) paymentStats[m] = { count:0, amount:0 };
      paymentStats[m].count++;
      paymentStats[m].amount += (Number(r.amount)||0);
    });

    const payContainer = document.getElementById("payment-distribution");
    const sortedPay = Object.entries(paymentStats).sort((a,b)=>b[1].amount-a[1].amount);

    if (sortedPay.length === 0) {
      payContainer.innerHTML = '<p class="text-gray-500 text-center py-2">ç„¡è³‡æ–™</p>';
    } else {
      payContainer.innerHTML = sortedPay.map(([m,s])=>{
        const prop = total>0 ? ((s.amount/total)*100).toFixed(1) : "0.0";
        return `
          <div class="flex justify-between items-center py-2 border-b border-gray-100">
            <div>
              <p class="font-semibold" style="color:#2d3748;">${escapeHtml(m)}</p>
              <p class="text-xs text-gray-500">${s.count} ç­†äº¤æ˜“</p>
            </div>
            <div class="text-right">
              <p class="font-bold" style="color:#667eea;">${getCurrency()}${s.amount.toLocaleString()}</p>
              <p class="text-xs text-gray-500">${prop}%</p>
            </div>
          </div>
        `;
      }).join("");
    }

    const listContainer = document.getElementById("analysis-records");
    if (filtered.length === 0) {
      listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">ç„¡ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>';
    } else {
      listContainer.innerHTML = filtered.slice(0,20).map(r=>{
        const d = new Date(r.timestamp);
        const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
        const timeStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        const note = r.note ? `<p class="text-xs text-gray-400 mt-1">${escapeHtml(r.note)}</p>` : "";
        return `
          <div class="flex justify-between items-center py-3 border-b border-gray-100">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold" style="color:#2d3748;">${escapeHtml(r.category||"å…¶ä»–")}</span>
                <span class="text-xs px-2 py-1 rounded" style="background:#f0f0f0; color:#666;">${escapeHtml(r.payment_method||"ç¾é‡‘")}</span>
              </div>
              <p class="text-xs text-gray-500">${dateStr} ${timeStr}</p>
              ${note}
            </div>
            <div class="text-lg font-bold" style="color:#667eea;">${getCurrency()}${Number(r.amount||0).toLocaleString()}</div>
          </div>
        `;
      }).join("");
      if (filtered.length > 20) {
        listContainer.innerHTML += '<p class="text-gray-500 text-center py-3 text-sm">åƒ…é¡¯ç¤ºå‰ 20 ç­†è¨˜éŒ„</p>';
      }
    }
  }

  function openEditModal(id) {
    const r = allRecords.find(x=>String(x.id)===String(id));
    if (!r) return;

    editTargetId = String(id);
    document.getElementById("edit-category").value = r.category || "";
    document.getElementById("edit-amount").value = Number(r.amount||0);
    document.getElementById("edit-payment").value = r.payment_method || "";
    document.getElementById("edit-note").value = r.note || "";

    const modal = document.getElementById("edit-modal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeEditModal() {
    editTargetId = null;
    const modal = document.getElementById("edit-modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  function saveEdit() {
    if (!editTargetId) return;

    const category = document.getElementById("edit-category").value.trim() || "å…¶ä»–";
    const amount = Number(document.getElementById("edit-amount").value);
    const payment = document.getElementById("edit-payment").value.trim() || "ç¾é‡‘";
    const note = document.getElementById("edit-note").value.trim();

    if (!amount || amount <= 0) {
      showErrorMessage("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
      return;
    }

    const idx = allRecords.findIndex(x=>String(x.id)===String(editTargetId));
    if (idx < 0) return;

    allRecords[idx] = {
      ...allRecords[idx],
      category,
      amount,
      payment_method: payment,
      note
    };

    allRecords.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
    saveLocal();
    updateUI();
    closeEditModal();
    showSuccessMessage("âœ“ å·²æ›´æ–°");
  }

  function deleteRecord(id) {
    const idx = allRecords.findIndex(x=>String(x.id)===String(id));
    if (idx < 0) return;

    const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ");
    if (!ok) return;

    allRecords.splice(idx, 1);
    saveLocal();
    updateUI();
    showSuccessMessage("âœ“ å·²åˆªé™¤");
  }

  function setRedirectUI(method, color, emoji, deepLink) {
    document.getElementById("redirect-payment-name").textContent = method;
    document.getElementById("redirect-payment-icon").textContent = emoji;
    document.getElementById("redirect-payment-icon").style.background = color;
    document.getElementById("pulse-ring").style.background = color + "40";
    document.getElementById("deep-link-url").textContent = deepLink || "app://payment";
  }

  function tryOpenDeepLink(deepLink) {
    try { window.location.href = deepLink; } catch (e) {}

    try {
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = deepLink;
      document.body.appendChild(iframe);
      setTimeout(()=>{ try { document.body.removeChild(iframe); } catch(e) {} }, 800);
    } catch (e) {}
  }

  let awaitingReturn = false;
  let returnTimer = null;

  function beginDeepLinkFlow(deepLink) {
    awaitingReturn = true;

    tryOpenDeepLink(deepLink);

    if (returnTimer) clearTimeout(returnTimer);
    returnTimer = setTimeout(()=>{
      if (awaitingReturn) {
        awaitingReturn = false;
        showScreen("step4-screen");
        document.getElementById("step4-title").textContent = "è¼¸å…¥é‡‘é¡";
        document.getElementById("final-payment-display").textContent = currentFlow.paymentMethod;
        showSuccessMessage("å·²å›åˆ°è¨˜å¸³æµç¨‹");
      }
    }, 2200);
  }

  document.addEventListener("visibilitychange", ()=>{
    if (!awaitingReturn) return;
    if (document.visibilityState === "hidden") {
      return;
    }
    if (document.visibilityState === "visible") {
      awaitingReturn = false;
      if (returnTimer) clearTimeout(returnTimer);
      showScreen("step4-screen");
      document.getElementById("step4-title").textContent = "è¼¸å…¥é‡‘é¡";
      document.getElementById("final-payment-display").textContent = currentFlow.paymentMethod;
    }
  });

  function addRecord({ category, amount, payment_method, carrier_used, note }) {
    const record = {
      id: String(Date.now()),
      category: category || "å…¶ä»–",
      amount: Number(amount)||0,
      payment_method: payment_method || "ç¾é‡‘",
      carrier_used: !!carrier_used,
      timestamp: new Date().toISOString(),
      note: note || ""
    };
    allRecords.unshift(record);
    allRecords.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
    saveLocal();
    updateUI();
  }

  function initPWA() {
    try {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      }
    } catch(e) {}
  }

  document.getElementById("apply-filter-btn").addEventListener("click", ()=>{
    analysisFilters = {
      startDate: document.getElementById("filter-start-date").value || null,
      endDate: document.getElementById("filter-end-date").value || null,
      category: document.getElementById("filter-category").value,
      minAmount: (document.getElementById("filter-min-amount").value === "" ? null : Number(document.getElementById("filter-min-amount").value)),
      maxAmount: (document.getElementById("filter-max-amount").value === "" ? null : Number(document.getElementById("filter-max-amount").value))
    };
    performAnalysis();
    showSuccessMessage("âœ“ ç¯©é¸å·²å¥—ç”¨");
  });

  document.getElementById("reset-filter-btn").addEventListener("click", ()=>{
    initializeAnalysisFilters();
    showSuccessMessage("âœ“ å·²é‡ç½®ç‚ºç•¶æœˆè³‡æ–™");
  });

  document.getElementById("settings-btn").addEventListener("click", ()=> showScreen("settings-screen"));
  document.getElementById("analysis-btn").addEventListener("click", ()=>{ initializeAnalysisFilters(); showScreen("analysis-screen"); });
  document.getElementById("back-from-analysis").addEventListener("click", ()=> showScreen("main-screen"));
  document.getElementById("back-from-settings").addEventListener("click", ()=> showScreen("main-screen"));

  document.getElementById("carrier-number-input").addEventListener("input", (e)=>{
    const v = e.target.value;
    if (v.length > 0) {
      document.getElementById("carrier-preview").classList.remove("hidden");
      document.getElementById("carrier-preview-text").textContent = v;
    } else {
      document.getElementById("carrier-preview").classList.add("hidden");
    }
  });

  document.getElementById("save-carrier-btn").addEventListener("click", ()=>{
    const carrierNumber = document.getElementById("carrier-number-input").value.trim();
    if (!carrierNumber) { showErrorMessage("è«‹è¼¸å…¥è¼‰å…·è™Ÿç¢¼"); return; }
    if (!carrierNumber.startsWith("/")) { showErrorMessage("è¼‰å…·è™Ÿç¢¼å¿…é ˆä»¥ / é–‹é ­"); return; }

    carrierSettings = { carrier_number: carrierNumber };
    saveLocal();
    updateCarrierDisplay();
    showSuccessMessage("âœ“ è¼‰å…·è¨­å®šå·²å„²å­˜");
  });

  document.getElementById("quick-expense-btn").addEventListener("click", ()=>{
    currentFlow = { category:"", paymentMethod:"", paymentColor:"", paymentEmoji:"", carrierUsed:false, pendingAmount:0 };
    renderCategoryGrid();
    showScreen("step1-screen");
  });

  document.getElementById("back-from-step1").addEventListener("click", ()=> showScreen("main-screen"));
  document.getElementById("back-from-step2").addEventListener("click", ()=> showScreen("step1-screen"));
  document.getElementById("back-from-step3").addEventListener("click", ()=> showScreen("step2-screen"));
  document.getElementById("back-from-step4").addEventListener("click", ()=> showScreen("step3-screen"));

  document.getElementById("add-category-btn").addEventListener("click", ()=>{
    document.getElementById("add-category-form").classList.remove("hidden");
    document.getElementById("new-category-input").focus();
  });

  document.getElementById("cancel-category-btn").addEventListener("click", ()=>{
    document.getElementById("add-category-form").classList.add("hidden");
    document.getElementById("new-category-input").value = "";
  });

  document.getElementById("save-category-btn").addEventListener("click", ()=>{
    const newCategory = document.getElementById("new-category-input").value.trim();
    if (newCategory && !customCategories.includes(newCategory) && !defaultCategories.includes(newCategory)) {
      customCategories.push(newCategory);
      saveLocal();
      renderCategoryGrid();
    }
    document.getElementById("add-category-form").classList.add("hidden");
    document.getElementById("new-category-input").value = "";
  });

  document.getElementById("skip-carrier-btn").addEventListener("click", ()=>{
    currentFlow.carrierUsed = false;
    showScreen("step3-screen");
  });

  document.getElementById("continue-to-payment-btn").addEventListener("click", ()=>{
    currentFlow.carrierUsed = true;
    showScreen("step3-screen");
  });

  document.querySelectorAll(".payment-method-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentFlow.paymentMethod = btn.dataset.method;
      currentFlow.paymentColor = btn.dataset.color;
      currentFlow.paymentEmoji = btn.dataset.emoji;
      document.getElementById("final-payment-display").textContent = currentFlow.paymentMethod;

      if (currentFlow.paymentMethod === "ç¾é‡‘") {
        document.getElementById("step4-title").textContent = "è¼¸å…¥é‡‘é¡";
        showScreen("step4-screen");
        return;
      }

      const deepLink = iosDeepLinks[currentFlow.paymentMethod] || "app://payment";
      setRedirectUI(currentFlow.paymentMethod, currentFlow.paymentColor, currentFlow.paymentEmoji, deepLink);
      showScreen("payment-redirect-screen");

      beginDeepLinkFlow(deepLink);
    }, { passive: true });
  });

  document.getElementById("manual-open-btn").addEventListener("click", ()=>{
    const deepLink = document.getElementById("deep-link-url").textContent.trim();
    if (deepLink) tryOpenDeepLink(deepLink);
  });

  document.getElementById("cancel-redirect-btn").addEventListener("click", ()=>{
    awaitingReturn = false;
    if (returnTimer) clearTimeout(returnTimer);
    showScreen("step3-screen");
  });

  document.getElementById("save-expense-btn").addEventListener("click", ()=>{
    const amount = Number(document.getElementById("amount-input").value);
    const note = document.getElementById("note-input").value.trim();

    if (!amount || amount <= 0) { showErrorMessage("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡"); return; }

    addRecord({
      category: currentFlow.category,
      amount,
      payment_method: currentFlow.paymentMethod || "ç¾é‡‘",
      carrier_used: currentFlow.carrierUsed,
      note
    });

    document.getElementById("amount-input").value = "";
    document.getElementById("note-input").value = "";
    showScreen("main-screen");
    showSuccessMessage("âœ“ è¨˜éŒ„å·²å„²å­˜");
  });

  document.getElementById("close-edit-modal").addEventListener("click", closeEditModal);
  document.getElementById("cancel-edit-btn").addEventListener("click", closeEditModal);
  document.getElementById("save-edit-btn").addEventListener("click", saveEdit);

  function init() {
    initPWA();
    loadLocal();
    updateCarrierDisplay();
    updateUI();
  }

  init();
</script>

</body>
</html>
