<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>æ™ºæ…§è¨˜å¸³APP - Deep Linkç‰ˆ</title>

  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="manifest" href="./manifest.webmanifest.json">

  <style>
    body { box-sizing: border-box; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .pulse-ring { animation: pulseRing 1.5s ease-out infinite; }
    @keyframes pulseRing { 0% { transform: scale(0.95); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>

<body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <!-- ä¸»ç•«é¢ -->
    <div id="main-screen" class="h-full flex flex-col">
      <header class="px-6 pt-8 pb-6">
        <div class="flex items-center justify-between mb-2">
          <h1 id="app-title" class="text-white text-3xl font-bold">æ™ºæ…§è¨˜å¸³</h1>
          <button id="settings-btn" class="text-white text-2xl w-10 h-10 flex items-center justify-center rounded-full hover:bg-white hover:bg-opacity-20 transition-all">âš™ï¸</button>
        </div>
        <div class="flex items-baseline gap-2">
          <span id="currency-symbol" class="text-white text-lg opacity-90">NT$</span>
          <span id="total-amount" class="text-white text-4xl font-bold">0</span>
        </div>
        <p class="text-white text-sm opacity-75 mt-1">æœ¬æœˆç¸½æ”¯å‡º</p>
      </header>

      <div class="px-6 mb-6 space-y-3">
        <button id="quick-expense-btn" class="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg" style="background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px);">
          <span class="text-2xl mr-2">â•</span> å¿«é€Ÿè¨˜ä¸€ç­†
        </button>
        <button id="analysis-btn" class="w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);">
          <span class="text-2xl mr-2">ğŸ“Š</span> æ¶ˆè²»åˆ†æ
        </button>
      </div>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background: #f8f9fa;">
        <section class="mb-6">
          <h2 class="text-lg font-bold mb-3" style="color: #2d3748;">æœ¬æœˆåˆ†é¡æ”¯å‡º</h2>
          <div id="category-stats" class="space-y-2"></div>
        </section>

        <section>
          <h2 class="text-lg font-bold mb-3" style="color: #2d3748;">æœ€è¿‘è¨˜éŒ„</h2>
          <div id="recent-records" class="space-y-2"></div>
        </section>
      </div>
    </div>

    <!-- æ¶ˆè²»åˆ†æç•«é¢ -->
    <div id="analysis-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-analysis" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">æ¶ˆè²»åˆ†æ</h1>
        <p class="text-white text-sm opacity-75 mt-1">æª¢è¦–æ‚¨çš„æ¶ˆè²»ç¿’æ…£èˆ‡çµ±è¨ˆ</p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background: #f8f9fa;">
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color: #2d3748;">ğŸ“… ç¯©é¸æ¢ä»¶</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">æ™‚é–“å€é–“</label>
              <div class="grid grid-cols-2 gap-2">
                <input type="date" id="filter-start-date" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color: #e2e8f0;">
                <input type="date" id="filter-end-date" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color: #e2e8f0;">
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">æ¶ˆè²»ç”¨é€”</label>
              <select id="filter-category" class="w-full px-3 py-2 rounded-lg border-2 text-sm" style="border-color: #e2e8f0;">
                <option value="all">å…¨éƒ¨ç”¨é€”</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">é‡‘é¡ç¯„åœ</label>
              <div class="grid grid-cols-2 gap-2">
                <input type="number" id="filter-min-amount" placeholder="æœ€ä½é‡‘é¡" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color: #e2e8f0;">
                <input type="number" id="filter-max-amount" placeholder="æœ€é«˜é‡‘é¡" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color: #e2e8f0;">
              </div>
            </div>

            <div class="flex gap-2">
              <button id="apply-filter-btn" class="flex-1 py-3 rounded-xl text-white font-semibold" style="background: #667eea;">å¥—ç”¨ç¯©é¸</button>
              <button id="reset-filter-btn" class="px-4 py-3 rounded-xl font-semibold" style="background: #e2e8f0; color: #4a5568;">é‡ç½®</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">ç¸½æ”¯å‡º</p>
            <p class="text-2xl font-bold" style="color: #667eea;"><span id="analysis-currency-1">NT$</span><span id="analysis-total">0</span></p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">ç­†æ•¸</p>
            <p class="text-2xl font-bold" style="color: #667eea;"><span id="analysis-count">0</span> ç­†</p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">å¹³å‡æ¶ˆè²»</p>
            <p class="text-2xl font-bold" style="color: #667eea;"><span id="analysis-currency-2">NT$</span><span id="analysis-average">0</span></p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">æœ€é«˜å–®ç­†</p>
            <p class="text-2xl font-bold" style="color: #667eea;"><span id="analysis-currency-3">NT$</span><span id="analysis-max">0</span></p>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color: #2d3748;">ğŸ“Š ç”¨é€”åˆ†å¸ƒ</h3>
          <div id="category-distribution" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color: #2d3748;">ğŸ’³ æ”¯ä»˜æ–¹å¼</h3>
          <div id="payment-distribution" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm">
          <h3 class="font-bold text-lg mb-4" style="color: #2d3748;">ğŸ“ æ¶ˆè²»æ˜ç´°</h3>
          <div id="analysis-records" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- è¼‰å…·è¨­å®šç•«é¢ -->
    <div id="settings-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-settings" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">è¼‰å…·è¨­å®š</h1>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background: #f8f9fa;">
        <div class="bg-white rounded-2xl p-6 shadow-sm mb-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background: #667eea;">ğŸ“±</div>
            <div>
              <h3 class="font-bold text-lg" style="color: #2d3748;">æ‰‹æ©Ÿæ¢ç¢¼è¼‰å…·</h3>
              <p class="text-xs text-gray-500">è¨­å®šå¾Œå°‡è‡ªå‹•é¡¯ç¤ºæ‚¨çš„è¼‰å…·æ¢ç¢¼</p>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-gray-700">è¼‰å…·è™Ÿç¢¼</label>
            <input type="text" id="carrier-number-input" placeholder="ä¾‹å¦‚: /ABC1234" class="w-full px-4 py-3 rounded-xl border-2 text-lg font-mono" style="border-color: #e2e8f0;" maxlength="8">
            <p class="text-xs text-gray-500 mt-2">è«‹è¼¸å…¥å®Œæ•´è¼‰å…·è™Ÿç¢¼ï¼ŒåŒ…å«é–‹é ­çš„ /</p>
          </div>

          <div id="carrier-preview" class="hidden mb-4">
            <p class="text-sm font-semibold mb-2 text-gray-700">é è¦½</p>
            <div class="bg-gray-50 rounded-xl p-4 border-2" style="border-color: #e2e8f0;">
              <div class="bg-white p-4 rounded-lg">
                <svg viewBox="0 0 200 60" class="w-full">
                  <rect x="5" y="5" width="2" height="50" fill="#000" />
                  <rect x="10" y="5" width="3" height="50" fill="#000" />
                  <rect x="16" y="5" width="2" height="50" fill="#000" />
                  <rect x="21" y="5" width="4" height="50" fill="#000" />
                  <rect x="28" y="5" width="2" height="50" fill="#000" />
                  <rect x="33" y="5" width="5" height="50" fill="#000" />
                  <rect x="41" y="5" width="2" height="50" fill="#000" />
                  <rect x="46" y="5" width="3" height="50" fill="#000" />
                  <rect x="52" y="5" width="2" height="50" fill="#000" />
                  <rect x="57" y="5" width="4" height="50" fill="#000" />
                </svg>
              </div>
              <p class="text-center text-sm font-mono mt-2" id="carrier-preview-text">/ABC1234</p>
            </div>
          </div>

          <button id="save-carrier-btn" class="w-full py-3 rounded-xl text-white font-semibold" style="background: #667eea;">
            <span id="save-carrier-text">å„²å­˜è¼‰å…·è¨­å®š</span>
          </button>
        </div>

        <div class="bg-blue-50 rounded-2xl p-4 border-2 border-blue-200">
          <div class="flex items-start gap-2">
            <span class="text-xl">â„¹ï¸</span>
            <div>
              <p class="text-sm font-semibold mb-1" style="color: #2d3748;">é—œæ–¼è¼‰å…·</p>
              <p class="text-xs text-gray-600">è¨­å®šå¾Œï¼Œæ¯æ¬¡è¨˜å¸³æ™‚æœƒè‡ªå‹•é¡¯ç¤ºæ‚¨çš„è¼‰å…·æ¢ç¢¼ã€‚<br>æ‚¨å¯ä»¥éš¨æ™‚å›åˆ°é€™è£¡ä¿®æ”¹è¼‰å…·è™Ÿç¢¼ã€‚</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ­¥é©Ÿ1: é¸æ“‡ç”¨é€” -->
    <div id="step1-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step1" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é¸æ“‡æ¶ˆè²»ç”¨é€”</h1>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background: #f8f9fa;">
        <div id="category-grid" class="grid grid-cols-3 gap-4 mb-6"></div>

        <button id="add-category-btn" class="w-full py-3 rounded-xl border-2 border-dashed text-gray-600 font-semibold" style="border-color: #cbd5e0;">
          <span class="text-xl mr-2">+</span> æ–°å¢åˆ†é¡
        </button>

        <div id="add-category-form" class="mt-4 hidden">
          <input type="text" id="new-category-input" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" class="w-full px-4 py-3 rounded-xl border-2 mb-3" style="border-color: #e2e8f0;">
          <div class="flex gap-2">
            <button id="save-category-btn" class="flex-1 py-3 rounded-xl text-white font-semibold" style="background: #667eea;">å„²å­˜</button>
            <button id="cancel-category-btn" class="flex-1 py-3 rounded-xl font-semibold" style="background: #e2e8f0; color: #4a5568;">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ­¥é©Ÿ2: è¼‰å…·æ¢ç¢¼ -->
    <div id="step2-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step2" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é›»å­ç™¼ç¥¨è¼‰å…·</h1>
        <p class="text-white text-sm opacity-75 mt-1" id="selected-category-display"></p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 flex flex-col" style="background: #f8f9fa;">
        <div class="flex-1 flex items-center justify-center mb-6">
          <div class="w-full max-w-sm bg-white rounded-2xl p-8 shadow-lg">
            <div class="text-center mb-4">
              <h3 class="text-lg font-bold mb-2" style="color: #2d3748;">æ‰‹æ©Ÿæ¢ç¢¼è¼‰å…·</h3>
              <p class="text-sm text-gray-500">è«‹å‡ºç¤ºæ­¤æ¢ç¢¼çµ¦åº—å“¡æƒæ</p>
            </div>

            <div class="bg-white p-6 rounded-xl border-2" style="border-color: #e2e8f0;">
              <svg viewBox="0 0 200 80" class="w-full">
                <rect x="5" y="10" width="3" height="60" fill="#000" />
                <rect x="12" y="10" width="2" height="60" fill="#000" />
                <rect x="18" y="10" width="4" height="60" fill="#000" />
                <rect x="26" y="10" width="2" height="60" fill="#000" />
                <rect x="32" y="10" width="6" height="60" fill="#000" />
                <rect x="42" y="10" width="2" height="60" fill="#000" />
                <rect x="48" y="10" width="4" height="60" fill="#000" />
                <rect x="56" y="10" width="2" height="60" fill="#000" />
                <rect x="62" y="10" width="3" height="60" fill="#000" />
                <rect x="69" y="10" width="5" height="60" fill="#000" />
                <rect x="78" y="10" width="2" height="60" fill="#000" />
                <rect x="84" y="10" width="4" height="60" fill="#000" />
                <rect x="92" y="10" width="2" height="60" fill="#000" />
                <rect x="98" y="10" width="6" height="60" fill="#000" />
                <rect x="108" y="10" width="3" height="60" fill="#000" />
                <rect x="115" y="10" width="2" height="60" fill="#000" />
                <rect x="121" y="10" width="5" height="60" fill="#000" />
                <rect x="130" y="10" width="2" height="60" fill="#000" />
                <rect x="136" y="10" width="4" height="60" fill="#000" />
                <rect x="144" y="10" width="3" height="60" fill="#000" />
                <rect x="151" y="10" width="2" height="60" fill="#000" />
                <rect x="157" y="10" width="6" height="60" fill="#000" />
                <rect x="167" y="10" width="2" height="60" fill="#000" />
                <rect x="173" y="10" width="4" height="60" fill="#000" />
                <rect x="181" y="10" width="3" height="60" fill="#000" />
                <rect x="188" y="10" width="2" height="60" fill="#000" />
              </svg>
            </div>

            <p class="text-center text-xs text-gray-400 mt-3" id="carrier-display-text">/ABC1234</p>
          </div>
        </div>

        <div class="space-y-3">
          <button id="skip-carrier-btn" class="w-full py-4 rounded-xl font-semibold" style="background: #e2e8f0; color: #4a5568;">è·³éè¼‰å…·ï¼Œç›´æ¥ä»˜æ¬¾</button>
          <button id="continue-to-payment-btn" class="w-full py-4 rounded-xl text-white font-semibold" style="background: #667eea;">ä½¿ç”¨è¼‰å…·å¾Œç¹¼çºŒ</button>
        </div>
      </div>
    </div>

    <!-- æ­¥é©Ÿ3: é¸æ“‡æ”¯ä»˜æ–¹å¼ -->
    <div id="step3-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step3" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é¸æ“‡æ”¯ä»˜æ–¹å¼</h1>
        <p class="text-white text-sm opacity-75 mt-1" id="selected-category-display2"></p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background: #f8f9fa;">
        <div class="space-y-3 mb-6">
          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="LINE Pay" data-color="#00B900" data-emoji="ğŸ’š">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background: #00B900;">ğŸ’š</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color: #2d3748;">LINE Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="Taiwan Pay" data-color="#0066CC" data-emoji="ğŸ¦">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background: #0066CC;">ğŸ¦</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color: #2d3748;">Taiwan Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="å…¨æ”¯ä»˜" data-color="#FF6B00" data-emoji="ğŸ”¶">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background: #FF6B00;">ğŸ”¶</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color: #2d3748;">å…¨æ”¯ä»˜ PX Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="è¡—å£æ”¯ä»˜" data-color="#FF3B3B" data-emoji="ğŸª">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background: #FF3B3B;">ğŸª</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color: #2d3748;">è¡—å£æ”¯ä»˜</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="æ‚ éŠä»˜" data-color="#0088FF" data-emoji="ğŸš‡">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background: #0088FF;">ğŸš‡</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color: #2d3748;">æ‚ éŠä»˜</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="ç¾é‡‘" data-color="#48BB78" data-emoji="ğŸ’µ">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background: #48BB78;">ğŸ’µ</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color: #2d3748;">ç¾é‡‘</div>
                <div class="text-xs text-gray-500">æ‰‹å‹•è¼¸å…¥é‡‘é¡</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Deep Link è·³è½‰ä¸­ç•«é¢ -->
    <div id="payment-redirect-screen" class="h-full flex-col hidden" style="background: #000000;">
      <div class="flex-1 flex items-center justify-center px-6">
        <div class="text-center">
          <div class="relative inline-block mb-8">
            <div class="absolute inset-0 w-32 h-32 rounded-full pulse-ring" id="pulse-ring" style="background: rgba(0, 185, 0, 0.3);"></div>
            <div class="w-32 h-32 rounded-3xl mx-auto flex items-center justify-center text-6xl shadow-2xl relative z-10" id="redirect-payment-icon" style="background: #00B900;">ğŸ’š</div>
          </div>

          <h2 class="text-white text-2xl font-bold mb-3" id="redirect-payment-name">LINE Pay</h2>
          <p class="text-white text-lg opacity-75 mb-8">æ­£åœ¨å•Ÿå‹•æ”¯ä»˜ APP...</p>

          <div class="flex justify-center space-x-2 mb-8">
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
          </div>

          <div class="bg-white bg-opacity-10 rounded-2xl p-4 backdrop-blur-lg max-w-sm mx-auto">
            <p class="text-white text-xs opacity-75 mb-2">ğŸ”— Deep Link URL</p>
            <p class="text-white text-xs font-mono break-all opacity-50" id="deep-link-url">line://pay/generateQR</p>
          </div>

          <div class="mt-6">
            <button id="manual-open-deeplink-btn" class="px-5 py-3 rounded-xl text-white font-semibold" style="background: rgba(255,255,255,0.18);">
              å¦‚æœæ²’æœ‰è‡ªå‹•è·³ï¼Œé»æˆ‘æ‰‹å‹•é–‹å•Ÿ
            </button>
            <button id="cancel-redirect-btn" class="ml-2 px-5 py-3 rounded-xl text-white font-semibold" style="background: rgba(255,255,255,0.10);">
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ä»˜æ¬¾æˆåŠŸé ï¼ˆç¤ºç¯„ï¼‰ -->
    <div id="payment-success-screen" class="h-full flex-col hidden">
      <div class="flex-1 flex items-center justify-center px-6" style="background: linear-gradient(135deg, #48BB78 0%, #38A169 100%);">
        <div class="text-center">
          <div class="relative inline-block mb-8">
            <div class="absolute inset-0 w-32 h-32 rounded-full bg-white opacity-20 animate-ping"></div>
            <div class="w-32 h-32 rounded-full mx-auto flex items-center justify-center bg-white shadow-2xl relative z-10"><span class="text-7xl">âœ“</span></div>
          </div>

          <h2 class="text-white text-3xl font-bold mb-3">å·²è¿”å›</h2>
          <div class="bg-white bg-opacity-20 rounded-2xl px-8 py-5 mb-6 backdrop-blur-lg">
            <p class="text-white text-sm opacity-90 mb-2">å·²ä»˜æ¬¾</p>
            <p class="text-white text-5xl font-bold mb-1"><span id="success-currency">NT$</span><span id="success-amount">0</span></p>
            <p class="text-white text-xs opacity-75 mt-2" id="success-category">æ—©é¤</p>
          </div>

          <div class="mb-6">
            <p class="text-white text-base opacity-90 mb-3">æ­£åœ¨å„²å­˜è¨˜éŒ„...</p>
            <div class="flex justify-center space-x-2">
              <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ­¥é©Ÿ4: æ‰‹å‹•è¼¸å…¥é‡‘é¡ï¼ˆåƒ…ç¾é‡‘ä½¿ç”¨ï¼‰ -->
    <div id="step4-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step4" class="text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">è¼¸å…¥é‡‘é¡</h1>
        <div class="mt-3 text-white text-sm opacity-90">
          <p>åˆ†é¡: <span id="final-category-display" class="font-semibold"></span></p>
          <p>æ”¯ä»˜: <span id="final-payment-display" class="font-semibold"></span></p>
        </div>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 flex flex-col" style="background: #f8f9fa;">
        <div class="flex-1 flex flex-col justify-center mb-6">
          <div class="text-center mb-8">
            <div class="flex items-baseline justify-center">
              <span id="currency-symbol-input" class="text-3xl text-gray-600 mr-2">NT$</span>
              <input type="number" id="amount-input" placeholder="0" class="text-6xl font-bold text-center border-0 outline-none bg-transparent w-full" style="color: #2d3748;" inputmode="decimal">
            </div>
          </div>

          <div class="bg-white rounded-2xl p-4 shadow-sm">
            <label class="block text-sm font-semibold mb-2 text-gray-700">å‚™è¨» (é¸å¡«)</label>
            <textarea id="note-input" placeholder="æ–°å¢å‚™è¨»..." class="w-full px-4 py-3 rounded-xl border-2 resize-none" style="border-color: #e2e8f0;" rows="3"></textarea>
          </div>
        </div>

        <button id="save-expense-btn" class="w-full py-4 rounded-xl text-white font-semibold text-lg shadow-lg" style="background: #667eea;">
          <span id="save-btn-text">å„²å­˜è¨˜éŒ„</span>
        </button>
      </div>
    </div>

    <!-- ç·¨è¼¯ç´€éŒ„ Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black bg-opacity-40"></div>
      <div class="absolute inset-x-0 bottom-0 bg-white rounded-t-3xl p-6 slide-up">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold" style="color:#2d3748;">ç·¨è¼¯è¨˜éŒ„</h3>
          <button id="close-edit-modal" class="text-2xl">âœ•</button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">åˆ†é¡</label>
            <input type="text" id="edit-category" class="w-full px-4 py-3 rounded-xl border-2" style="border-color:#e2e8f0;">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">é‡‘é¡</label>
            <input type="number" id="edit-amount" class="w-full px-4 py-3 rounded-xl border-2" style="border-color:#e2e8f0;" inputmode="decimal">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">æ”¯ä»˜æ–¹å¼</label>
            <input type="text" id="edit-payment" class="w-full px-4 py-3 rounded-xl border-2" style="border-color:#e2e8f0;">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">å‚™è¨»</label>
            <textarea id="edit-note" class="w-full px-4 py-3 rounded-xl border-2 resize-none" style="border-color:#e2e8f0;" rows="3"></textarea>
          </div>

          <div class="flex gap-2 pt-2">
            <button id="save-edit-btn" class="flex-1 py-3 rounded-xl text-white font-semibold" style="background:#667eea;">å„²å­˜ä¿®æ”¹</button>
            <button id="cancel-edit-btn" class="px-5 py-3 rounded-xl font-semibold" style="background:#e2e8f0; color:#4a5568;">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const defaultConfig = {
      app_title: "æ™ºæ…§è¨˜å¸³",
      currency_symbol: "NT$"
    };

    let allRecords = [];
    let carrierSettings = null;

    let currentFlow = {
      category: "",
      paymentMethod: "",
      paymentColor: "",
      paymentEmoji: "",
      carrierUsed: false,
      pendingAmount: 0
    };

    const defaultCategories = ["æ—©é¤", "åˆé¤", "æ™šé¤", "äº¤é€š", "å¨›æ¨‚", "è³¼ç‰©", "å…¶ä»–"];
    let customCategories = [];

    // dataSdk / fallback
    const storageMode = { mode: "dataSdk" };
    const localKey = "blip_records_v1";

    function safeParseJSON(str, fallback) {
      try { return JSON.parse(str); } catch { return fallback; }
    }

    function localLoadAll() {
      const raw = localStorage.getItem(localKey);
      const arr = safeParseJSON(raw, []);
      return Array.isArray(arr) ? arr : [];
    }
    function localSaveAll(arr) {
      localStorage.setItem(localKey, JSON.stringify(arr));
    }

    async function dsInit(handler) {
      if (window.dataSdk && typeof window.dataSdk.init === "function") {
        const result = await window.dataSdk.init(handler);
        if (result && result.isOk) {
          storageMode.mode = "dataSdk";
          return true;
        }
      }
      storageMode.mode = "local";
      // ç”¨ local æ¨¡å¼ä¹Ÿå‘¼å«ä¸€æ¬¡ handler
      handler.onDataChanged(localLoadAll());
      return false;
    }

    async function dsCreate(record) {
      if (storageMode.mode === "dataSdk" && window.dataSdk && typeof window.dataSdk.create === "function") {
        const r = await window.dataSdk.create(record);
        return r;
      }
      const arr = localLoadAll();
      arr.push(record);
      localSaveAll(arr);
      dataHandler.onDataChanged(arr);
      return { isOk: true };
    }

    async function dsUpdate(record) {
      if (storageMode.mode === "dataSdk" && window.dataSdk && typeof window.dataSdk.update === "function") {
        const r = await window.dataSdk.update(record);
        return r;
      }
      const arr = localLoadAll();
      const idx = arr.findIndex(x => x.id === record.id);
      if (idx >= 0) arr[idx] = record;
      localSaveAll(arr);
      dataHandler.onDataChanged(arr);
      return { isOk: true };
    }

    async function dsDelete(record) {
      if (storageMode.mode === "dataSdk" && window.dataSdk && typeof window.dataSdk.delete === "function") {
        const r = await window.dataSdk.delete(record);
        return r;
      }
      const arr = localLoadAll().filter(x => x.id !== record.id);
      localSaveAll(arr);
      dataHandler.onDataChanged(arr);
      return { isOk: true };
    }

    function showSuccessMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = message;
      messageDiv.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
      document.body.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 1600);
    }

    function showErrorMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = message;
      messageDiv.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50';
      document.body.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 1600);
    }

    const dataHandler = {
      onDataChanged(data) {
        const settings = (data || []).find(record => record && record.is_settings === true);
        const expenses = (data || []).filter(record => record && record.is_settings !== true);

        carrierSettings = settings || null;
        allRecords = expenses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        updateUI();
        updateCarrierDisplay();
        updateCategoryFilter();
      }
    };

    let analysisFilters = {
      startDate: null,
      endDate: null,
      category: 'all',
      minAmount: null,
      maxAmount: null
    };

    async function onConfigChange(config) {
      const appTitleElements = document.querySelectorAll('#app-title');
      appTitleElements.forEach(el => { el.textContent = config.app_title || defaultConfig.app_title; });

      const currencyElements = document.querySelectorAll('#currency-symbol, #currency-symbol-input, #success-currency, #analysis-currency-1, #analysis-currency-2, #analysis-currency-3');
      currencyElements.forEach(el => { el.textContent = config.currency_symbol || defaultConfig.currency_symbol; });
    }

    function updateCarrierDisplay() {
      if (carrierSettings && carrierSettings.carrier_number) {
        const carrierText = carrierSettings.carrier_number;
        document.getElementById('carrier-display-text').textContent = carrierText;
        document.getElementById('carrier-number-input').value = carrierText;
        document.getElementById('carrier-preview-text').textContent = carrierText;
        document.getElementById('carrier-preview').classList.remove('hidden');
      } else {
        document.getElementById('carrier-display-text').textContent = '/ABC1234';
        document.getElementById('carrier-number-input').value = '';
        document.getElementById('carrier-preview').classList.add('hidden');
      }
    }

    function updateUI() {
      updateTotalAmount();
      updateCategoryStats();
      updateRecentRecords();
    }

    function updateTotalAmount() {
      const total = allRecords.reduce((sum, record) => sum + (Number(record.amount) || 0), 0);
      document.getElementById('total-amount').textContent = total.toLocaleString();
    }

    function updateCategoryStats() {
      const statsContainer = document.getElementById('category-stats');
      const categoryTotals = {};

      allRecords.forEach(record => {
        if (!categoryTotals[record.category]) categoryTotals[record.category] = 0;
        categoryTotals[record.category] += (Number(record.amount) || 0);
      });

      const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).slice(0, 5);

      if (sortedCategories.length === 0) {
        statsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">å°šç„¡æ¶ˆè²»è¨˜éŒ„</p>';
        return;
      }

      const maxAmount = Math.max(...sortedCategories.map(([_, amount]) => amount));

      statsContainer.innerHTML = sortedCategories.map(([category, amount]) => {
        const percentage = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
        return `
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <div class="flex justify-between mb-2">
              <span class="font-semibold" style="color: #2d3748;">${category}</span>
              <span class="font-bold" style="color: #667eea;">${(window.elementSdk?.config?.currency_symbol || defaultConfig.currency_symbol)}${amount.toLocaleString()}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="h-2 rounded-full" style="width: ${percentage}%; background: #667eea;"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateRecentRecords() {
      const container = document.getElementById('recent-records');
      const recentRecords = allRecords.slice(0, 10);

      if (recentRecords.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">å°šç„¡æ¶ˆè²»è¨˜éŒ„</p>';
        return;
      }

      container.innerHTML = recentRecords.map(record => {
        const date = new Date(record.timestamp);
        const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

        const amountStr = `${(window.elementSdk?.config?.currency_symbol || defaultConfig.currency_symbol)}${(Number(record.amount) || 0).toLocaleString()}`;

        return `
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <div class="flex justify-between items-start">
              <div class="flex-1 pr-3">
                <div class="font-semibold text-lg mb-1" style="color: #2d3748;">${record.category || ''}</div>
                <div class="text-sm text-gray-500">${record.payment_method || ''} Â· ${timeStr}</div>
                ${record.note ? `<div class="text-sm text-gray-400 mt-1">${record.note}</div>` : ''}
              </div>
              <div class="text-right">
                <div class="text-xl font-bold" style="color: #667eea;">${amountStr}</div>
                <div class="mt-2 flex gap-2 justify-end">
                  <button class="edit-record-btn px-4 py-2 rounded-lg font-semibold" style="background:#edf2f7;color:#2d3748;" data-id="${record.id}">ç·¨è¼¯</button>
                  <button class="delete-record-btn px-4 py-2 rounded-lg font-semibold" style="background:#fed7d7;color:#c53030;" data-id="${record.id}">åˆªé™¤</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.querySelectorAll('.edit-record-btn').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.dataset.id));
      });
      document.querySelectorAll('.delete-record-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteRecordFlow(btn.dataset.id));
      });
    }

    function showScreen(screenId) {
      const screens = ['main-screen', 'analysis-screen', 'settings-screen', 'step1-screen', 'step2-screen', 'step3-screen', 'step4-screen', 'payment-redirect-screen', 'payment-success-screen'];
      screens.forEach(id => {
        const screen = document.getElementById(id);
        if (!screen) return;
        if (id === screenId) {
          screen.classList.remove('hidden');
          screen.classList.add('flex', 'fade-in');
        } else {
          screen.classList.add('hidden');
          screen.classList.remove('flex');
        }
      });
    }

    function renderCategoryGrid() {
      const grid = document.getElementById('category-grid');
      const allCategories = [...defaultCategories, ...customCategories];

      grid.innerHTML = allCategories.map(category => `
        <button class="category-btn p-6 rounded-2xl bg-white shadow-sm text-center font-semibold transition-all hover:shadow-md" data-category="${category}" style="color: #2d3748;">
          ${getCategoryEmoji(category)}<br><span class="text-sm">${category}</span>
        </button>
      `).join('');

      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentFlow.category = btn.dataset.category;
          document.getElementById('selected-category-display').textContent = `åˆ†é¡: ${currentFlow.category}`;
          document.getElementById('selected-category-display2').textContent = `åˆ†é¡: ${currentFlow.category}`;
          document.getElementById('final-category-display').textContent = currentFlow.category;
          document.getElementById('success-category').textContent = currentFlow.category;
          showScreen('step2-screen');
        });
      });
    }

    function getCategoryEmoji(category) {
      const emojiMap = { 'æ—©é¤':'ğŸ³','åˆé¤':'ğŸ±','æ™šé¤':'ğŸ½ï¸','äº¤é€š':'ğŸš—','å¨›æ¨‚':'ğŸ®','è³¼ç‰©':'ğŸ›ï¸','å…¶ä»–':'ğŸ“' };
      return emojiMap[category] || 'ğŸ’°';
    }

    function initializeAnalysisFilters() {
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      document.getElementById('filter-start-date').value = formatDate(firstDay);
      document.getElementById('filter-end-date').value = formatDate(lastDay);
      document.getElementById('filter-min-amount').value = '';
      document.getElementById('filter-max-amount').value = '';
      document.getElementById('filter-category').value = 'all';

      analysisFilters = { startDate: formatDate(firstDay), endDate: formatDate(lastDay), category: 'all', minAmount: null, maxAmount: null };

      updateCategoryFilter();
      performAnalysis();
    }

    function updateCategoryFilter() {
      const select = document.getElementById('filter-category');
      if (!select) return;
      const categories = new Set();
      allRecords.forEach(record => { if (record.category) categories.add(record.category); });
      select.innerHTML = '<option value="all">å…¨éƒ¨ç”¨é€”</option>';
      Array.from(categories).sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
      });
    }

    function getFilteredRecords() {
      return allRecords.filter(record => {
        const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
        if (analysisFilters.startDate && recordDate < analysisFilters.startDate) return false;
        if (analysisFilters.endDate && recordDate > analysisFilters.endDate) return false;
        if (analysisFilters.category !== 'all' && record.category !== analysisFilters.category) return false;
        if (analysisFilters.minAmount != null && record.amount < analysisFilters.minAmount) return false;
        if (analysisFilters.maxAmount != null && record.amount > analysisFilters.maxAmount) return false;
        return true;
      });
    }

    function performAnalysis() {
      const filteredRecords = getFilteredRecords();

      const total = filteredRecords.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
      const count = filteredRecords.length;
      const average = count > 0 ? Math.round(total / count) : 0;
      const max = count > 0 ? Math.max(...filteredRecords.map(r => Number(r.amount) || 0)) : 0;

      document.getElementById('analysis-total').textContent = total.toLocaleString();
      document.getElementById('analysis-count').textContent = count;
      document.getElementById('analysis-average').textContent = average.toLocaleString();
      document.getElementById('analysis-max').textContent = max.toLocaleString();

      const categoryStats = {};
      filteredRecords.forEach(record => {
        if (!categoryStats[record.category]) categoryStats[record.category] = 0;
        categoryStats[record.category] += (Number(record.amount) || 0);
      });

      const sortedCategories = Object.entries(categoryStats).sort((a, b) => b[1] - a[1]);
      const categoryContainer = document.getElementById('category-distribution');

      if (sortedCategories.length === 0) {
        categoryContainer.innerHTML = '<p class="text-gray-500 text-center py-2">ç„¡è³‡æ–™</p>';
      } else {
        const maxCategoryAmount = Math.max(...sortedCategories.map(([_, amount]) => amount));
        categoryContainer.innerHTML = sortedCategories.map(([category, amount]) => {
          const percentage = maxCategoryAmount > 0 ? (amount / maxCategoryAmount) * 100 : 0;
          const proportion = total > 0 ? ((amount / total) * 100).toFixed(1) : '0.0';
          return `
            <div>
              <div class="flex justify-between mb-1 text-sm">
                <span class="font-semibold" style="color: #2d3748;">${category}</span>
                <span class="text-gray-600">${(window.elementSdk?.config?.currency_symbol || defaultConfig.currency_symbol)}${amount.toLocaleString()} (${proportion}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full" style="width: ${percentage}%; background: #667eea;"></div>
              </div>
            </div>
          `;
        }).join('');
      }

      const paymentStats = {};
      filteredRecords.forEach(record => {
        if (!paymentStats[record.payment_method]) paymentStats[record.payment_method] = { count: 0, amount: 0 };
        paymentStats[record.payment_method].count++;
        paymentStats[record.payment_method].amount += (Number(record.amount) || 0);
      });

      const sortedPayments = Object.entries(paymentStats).sort((a, b) => b[1].amount - a[1].amount);
      const paymentContainer = document.getElementById('payment-distribution');

      if (sortedPayments.length === 0) {
        paymentContainer.innerHTML = '<p class="text-gray-500 text-center py-2">ç„¡è³‡æ–™</p>';
      } else {
        paymentContainer.innerHTML = sortedPayments.map(([method, stats]) => {
          const proportion = total > 0 ? ((stats.amount / total) * 100).toFixed(1) : '0.0';
          return `
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <div>
                <p class="font-semibold" style="color: #2d3748;">${method}</p>
                <p class="text-xs text-gray-500">${stats.count} ç­†äº¤æ˜“</p>
              </div>
              <div class="text-right">
                <p class="font-bold" style="color: #667eea;">${(window.elementSdk?.config?.currency_symbol || defaultConfig.currency_symbol)}${stats.amount.toLocaleString()}</p>
                <p class="text-xs text-gray-500">${proportion}%</p>
              </div>
            </div>
          `;
        }).join('');
      }

      const recordsContainer = document.getElementById('analysis-records');

      if (filteredRecords.length === 0) {
        recordsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">ç„¡ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>';
      } else {
        recordsContainer.innerHTML = filteredRecords.slice(0, 20).map(record => {
          const date = new Date(record.timestamp);
          const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
          const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          return `
            <div class="flex justify-between items-center py-3 border-b border-gray-100">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-semibold" style="color: #2d3748;">${record.category}</span>
                  <span class="text-xs px-2 py-1 rounded" style="background: #f0f0f0; color: #666;">${record.payment_method}</span>
                </div>
                <p class="text-xs text-gray-500">${dateStr} ${timeStr}</p>
                ${record.note ? `<p class="text-xs text-gray-400 mt-1">${record.note}</p>` : ''}
              </div>
              <div class="text-lg font-bold" style="color: #667eea;">${(window.elementSdk?.config?.currency_symbol || defaultConfig.currency_symbol)}${(Number(record.amount) || 0).toLocaleString()}</div>
            </div>
          `;
        }).join('');

        if (filteredRecords.length > 20) {
          recordsContainer.innerHTML += '<p class="text-gray-500 text-center py-3 text-sm">åƒ…é¡¯ç¤ºå‰ 20 ç­†è¨˜éŒ„</p>';
        }
      }
    }

    // ç·¨è¼¯/åˆªé™¤
    let editingId = null;
    function openEditModal(id) {
      const record = allRecords.find(r => r.id === id);
      if (!record) return;
      editingId = id;
      document.getElementById('edit-category').value = record.category || '';
      document.getElementById('edit-amount').value = Number(record.amount) || 0;
      document.getElementById('edit-payment').value = record.payment_method || '';
      document.getElementById('edit-note').value = record.note || '';
      document.getElementById('edit-modal').classList.remove('hidden');
    }
    function closeEditModal() {
      editingId = null;
      document.getElementById('edit-modal').classList.add('hidden');
    }

    async function deleteRecordFlow(id) {
      const record = allRecords.find(r => r.id === id);
      if (!record) return;
      const ok = confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ');
      if (!ok) return;
      const result = await dsDelete(record);
      if (result && result.isOk) showSuccessMessage('âœ“ å·²åˆªé™¤');
      else showErrorMessage('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
    }

    // UIäº‹ä»¶ï¼šåˆ†æèˆ‡è¨­å®š
    document.getElementById('apply-filter-btn').addEventListener('click', () => {
      analysisFilters = {
        startDate: document.getElementById('filter-start-date').value || null,
        endDate: document.getElementById('filter-end-date').value || null,
        category: document.getElementById('filter-category').value,
        minAmount: parseFloat(document.getElementById('filter-min-amount').value) || null,
        maxAmount: parseFloat(document.getElementById('filter-max-amount').value) || null
      };
      performAnalysis();
      showSuccessMessage('âœ“ ç¯©é¸å·²å¥—ç”¨');
    });

    document.getElementById('reset-filter-btn').addEventListener('click', () => {
      initializeAnalysisFilters();
      showSuccessMessage('âœ“ å·²é‡ç½®');
    });

    document.getElementById('settings-btn').addEventListener('click', () => showScreen('settings-screen'));

    document.getElementById('analysis-btn').addEventListener('click', () => {
      initializeAnalysisFilters();
      showScreen('analysis-screen');
    });

    document.getElementById('back-from-analysis').addEventListener('click', () => showScreen('main-screen'));
    document.getElementById('back-from-settings').addEventListener('click', () => showScreen('main-screen'));

    // è¼‰å…·è¼¸å…¥
    document.getElementById('carrier-number-input').addEventListener('input', (e) => {
      const value = e.target.value;
      if (value.length > 0) {
        document.getElementById('carrier-preview').classList.remove('hidden');
        document.getElementById('carrier-preview-text').textContent = value;
      } else {
        document.getElementById('carrier-preview').classList.add('hidden');
      }
    });

    document.getElementById('save-carrier-btn').addEventListener('click', async () => {
      const carrierNumber = document.getElementById('carrier-number-input').value.trim();

      if (!carrierNumber) { showErrorMessage('è«‹è¼¸å…¥è¼‰å…·è™Ÿç¢¼'); return; }
      if (!carrierNumber.startsWith('/')) { showErrorMessage('è¼‰å…·è™Ÿç¢¼å¿…é ˆä»¥ / é–‹é ­'); return; }

      const saveBtn = document.getElementById('save-carrier-btn');
      const btnText = document.getElementById('save-carrier-text');
      saveBtn.disabled = true;
      btnText.textContent = 'å„²å­˜ä¸­...';

      if (carrierSettings) {
        const updatedSettings = { ...carrierSettings, carrier_number: carrierNumber };
        const result = await dsUpdate(updatedSettings);
        if (result && result.isOk) showSuccessMessage('âœ“ è¼‰å…·è¨­å®šå·²æ›´æ–°');
        else showErrorMessage('æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦');
      } else {
        const newSettings = {
          id: 'carrier-settings',
          carrier_number: carrierNumber,
          is_settings: true,
          category: '',
          amount: 0,
          payment_method: '',
          carrier_used: false,
          timestamp: new Date().toISOString(),
          note: ''
        };
        const result = await dsCreate(newSettings);
        if (result && result.isOk) showSuccessMessage('âœ“ è¼‰å…·è¨­å®šå·²å„²å­˜');
        else showErrorMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
      }

      saveBtn.disabled = false;
      btnText.textContent = 'å„²å­˜è¼‰å…·è¨­å®š';
    });

    // å¿«é€Ÿè¨˜å¸³æµç¨‹
    document.getElementById('quick-expense-btn').addEventListener('click', () => {
      currentFlow = { category: "", paymentMethod: "", paymentColor: "", paymentEmoji: "", carrierUsed: false, pendingAmount: 0 };
      renderCategoryGrid();
      showScreen('step1-screen');
    });

    document.getElementById('back-from-step1').addEventListener('click', () => showScreen('main-screen'));
    document.getElementById('back-from-step2').addEventListener('click', () => showScreen('step1-screen'));
    document.getElementById('back-from-step3').addEventListener('click', () => showScreen('step2-screen'));
    document.getElementById('back-from-step4').addEventListener('click', () => showScreen('step3-screen'));

    document.getElementById('add-category-btn').addEventListener('click', () => {
      document.getElementById('add-category-form').classList.remove('hidden');
      document.getElementById('new-category-input').focus();
    });

    document.getElementById('cancel-category-btn').addEventListener('click', () => {
      document.getElementById('add-category-form').classList.add('hidden');
      document.getElementById('new-category-input').value = '';
    });

    document.getElementById('save-category-btn').addEventListener('click', () => {
      const newCategory = document.getElementById('new-category-input').value.trim();
      if (newCategory && !customCategories.includes(newCategory) && !defaultCategories.includes(newCategory)) {
        customCategories.push(newCategory);
        renderCategoryGrid();
      }
      document.getElementById('add-category-form').classList.add('hidden');
      document.getElementById('new-category-input').value = '';
    });

    document.getElementById('skip-carrier-btn').addEventListener('click', () => {
      currentFlow.carrierUsed = false;
      showScreen('step3-screen');
    });

    document.getElementById('continue-to-payment-btn').addEventListener('click', () => {
      currentFlow.carrierUsed = true;
      showScreen('step3-screen');
    });

    // DeepLinkï¼šè‡ªå‹•è·³ï¼ˆiOS PWA æœ€ç©©åšæ³•ï¼‰
    const iosDeepLinks = {
      'LINE Pay': 'line://pay/generateQR',
      'Taiwan Pay': 'twmpshortcut://?type=payment',
      'å…¨æ”¯ä»˜': 'com.pxpay.plus://zjdja',
      'è¡—å£æ”¯ä»˜': 'jkos://showQRCode',
      'æ‚ éŠä»˜': 'tw.com.easycard.easycardwallet://paymentCode'
    };

    let lastDeepLink = '';
    function tryOpenDeepLink(deepLink) {
      lastDeepLink = deepLink || '';
      if (!lastDeepLink) return;

      requestAnimationFrame(() => {
        window.location.href = lastDeepLink;

        // è‹¥è¢«æ“‹/æ²’è£appï¼šå®‰éœå›é€€
        setTimeout(() => {
          if (!document.hidden) {
            showScreen('step3-screen');
          }
        }, 1200);
      });
    }

    document.getElementById('manual-open-deeplink-btn').addEventListener('click', () => {
      if (!lastDeepLink) return;
      window.location.href = lastDeepLink;
    });

    document.getElementById('cancel-redirect-btn').addEventListener('click', () => {
      showScreen('step3-screen');
    });

    // ä»˜æ¬¾æ–¹å¼é»æ“Šï¼ˆç¾é‡‘/DeepLinkï¼‰
    document.querySelectorAll('.payment-method-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentFlow.paymentMethod = btn.dataset.method;
        currentFlow.paymentColor = btn.dataset.color;
        currentFlow.paymentEmoji = btn.dataset.emoji;
        document.getElementById('final-payment-display').textContent = currentFlow.paymentMethod;

        if (currentFlow.paymentMethod === 'ç¾é‡‘') {
          showScreen('step4-screen');
          return;
        }

        const deepLink = iosDeepLinks[currentFlow.paymentMethod] || '';
        document.getElementById('redirect-payment-name').textContent = currentFlow.paymentMethod;
        document.getElementById('redirect-payment-icon').textContent = currentFlow.paymentEmoji;
        document.getElementById('redirect-payment-icon').style.background = currentFlow.paymentColor;
        document.getElementById('pulse-ring').style.background = currentFlow.paymentColor + '40';
        document.getElementById('deep-link-url').textContent = deepLink || 'app://payment';

        showScreen('payment-redirect-screen');

        // âœ… é—œéµï¼šä¸è¦ setTimeout ç­‰å¾…ï¼Œç›´æ¥åœ¨åŒä¸€æ¬¡æ‰‹å‹¢éˆå…§å•Ÿå‹•è·³è½‰
        tryOpenDeepLink(deepLink);
      }, { passive: true });
    });

    // å›è·³åµæ¸¬ï¼šå¦‚æœæ”¯ä»˜appå›åˆ°PWAï¼Œæˆ‘å€‘é¡¯ç¤ºã€Œå·²è¿”å›ã€ä¸¦æç¤ºå¯æ‰‹å‹•è¼¸å…¥ï¼ˆçœŸå¯¦é‡‘é¡å›å¯«éœ€æ”¯ä»˜appæ”¯æ´ callbackï¼‰
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        // å›åˆ°å‰å°ï¼Œé¡¯ç¤ºæˆåŠŸç•«é¢ï¼ˆç¤ºç¯„ï¼‰ï¼Œä¸é¡¯ç¤ºä»»ä½•ç´…æ¡†/è­¦å‘Š
        // çœŸæ­£é‡‘é¡è‡ªå‹•å›å¯«ï¼šéœ€è¦æ”¯ä»˜appæä¾›å›è·³å¸¶åƒæ•¸/SDK/Server callbackï¼Œå–®ç´” deeplink ç„¡æ³•ä¿è­‰æ‹¿åˆ°é‡‘é¡
      }
    });

    // ç¾é‡‘æ”¯ä»˜å­˜æª”ï¼ˆæ­£å¸¸å¯å­˜ï¼‰
    document.getElementById('save-expense-btn').addEventListener('click', async () => {
      const amount = parseFloat(document.getElementById('amount-input').value);
      const note = document.getElementById('note-input').value.trim();

      if (!amount || amount <= 0) { showErrorMessage('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }

      const saveBtn = document.getElementById('save-expense-btn');
      const btnText = document.getElementById('save-btn-text');
      saveBtn.disabled = true;
      btnText.textContent = 'å„²å­˜ä¸­...';

      const record = {
        id: Date.now().toString(),
        category: currentFlow.category,
        amount: amount,
        payment_method: currentFlow.paymentMethod,
        carrier_used: currentFlow.carrierUsed,
        timestamp: new Date().toISOString(),
        note: note,
        carrier_number: '',
        is_settings: false
      };

      const result = await dsCreate(record);

      if (result && result.isOk) {
        document.getElementById('amount-input').value = '';
        document.getElementById('note-input').value = '';
        showScreen('main-screen');
        showSuccessMessage('âœ“ è¨˜éŒ„å·²å„²å­˜');
      } else {
        showErrorMessage('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
      }

      saveBtn.disabled = false;
      btnText.textContent = 'å„²å­˜è¨˜éŒ„';
    });

    // ç·¨è¼¯Modaläº‹ä»¶
    document.getElementById('close-edit-modal').addEventListener('click', closeEditModal);
    document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);

    document.getElementById('save-edit-btn').addEventListener('click', async () => {
      if (!editingId) return;
      const record = allRecords.find(r => r.id === editingId);
      if (!record) return;

      const newCategory = document.getElementById('edit-category').value.trim();
      const newAmount = parseFloat(document.getElementById('edit-amount').value);
      const newPayment = document.getElementById('edit-payment').value.trim();
      const newNote = document.getElementById('edit-note').value.trim();

      if (!newCategory) { showErrorMessage('åˆ†é¡ä¸å¯ç©ºç™½'); return; }
      if (!newPayment) { showErrorMessage('æ”¯ä»˜æ–¹å¼ä¸å¯ç©ºç™½'); return; }
      if (!newAmount || newAmount <= 0) { showErrorMessage('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }

      const updated = { ...record, category: newCategory, amount: newAmount, payment_method: newPayment, note: newNote };
      const res = await dsUpdate(updated);
      if (res && res.isOk) {
        closeEditModal();
        showSuccessMessage('âœ“ å·²æ›´æ–°');
      } else {
        showErrorMessage('æ›´æ–°å¤±æ•—');
      }
    });

    async function init() {
      // PWA SW
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
      }

      // element sdk
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["currency_symbol", config.currency_symbol || defaultConfig.currency_symbol]
          ])
        });
      }

      // data sdk or local fallback
      await dsInit(dataHandler);

      // åˆå§‹ç•«é¢
      showScreen('main-screen');
    }

    init();
  </script>
</body>
</html>
