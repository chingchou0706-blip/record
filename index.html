<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºæ…§è¨˜å¸³APP - Deep Linkç‰ˆ</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{box-sizing:border-box}
    .fade-in{animation:fadeIn .3s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .slide-up{animation:slideUp .25s ease-out}
    @keyframes slideUp{from{transform:translateY(12px);opacity:.5}to{transform:translateY(0);opacity:1}}
    .pulse-ring{animation:pulseRing 1.5s ease-out infinite}
    @keyframes pulseRing{0%{transform:scale(.95);opacity:1}100%{transform:scale(1.3);opacity:0}}
    .modal-backdrop{background:rgba(0,0,0,.45)}
    .sheet{border-top-left-radius:24px;border-top-right-radius:24px}
    .swipe-row{position:relative;overflow:hidden;border-radius:12px}
    .swipe-actions{position:absolute;top:0;right:0;height:100%;display:flex;align-items:center;gap:8px;padding-right:12px}
    .swipe-content{position:relative;z-index:2;transform:translateX(0);transition:transform .18s ease}
    .swipe-revealed .swipe-content{transform:translateX(-92px)}
    .tap-highlight{-webkit-tap-highlight-color:transparent}
  </style>
  <style>@view-transition{navigation:auto}</style>
</head>

<body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
    <div id="main-screen" class="h-full flex flex-col">
      <header class="px-6 pt-8 pb-6">
        <div class="flex items-center justify-between mb-2">
          <h1 id="app-title" class="text-white text-3xl font-bold">æ™ºæ…§è¨˜å¸³</h1>
          <button id="settings-btn" class="tap-highlight text-white text-2xl w-10 h-10 flex items-center justify-center rounded-full hover:bg-white hover:bg-opacity-20 transition-all">âš™ï¸</button>
        </div>
        <div class="flex items-baseline gap-2">
          <span id="currency-symbol" class="text-white text-lg opacity-90">NT$</span>
          <span id="total-amount" class="text-white text-4xl font-bold">0</span>
        </div>
        <p class="text-white text-sm opacity-75 mt-1">æœ¬æœˆç¸½æ”¯å‡º</p>
      </header>

      <div class="px-6 mb-6 space-y-3">
        <button id="quick-expense-btn" class="tap-highlight w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg" style="background:rgba(255,255,255,.25);backdrop-filter:blur(10px);">
          <span class="text-2xl mr-2">â•</span>å¿«é€Ÿè¨˜ä¸€ç­†
        </button>
        <button id="analysis-btn" class="tap-highlight w-full py-4 rounded-2xl text-white text-lg font-semibold shadow-lg" style="background:rgba(255,255,255,.2);backdrop-filter:blur(10px);">
          <span class="text-2xl mr-2">ğŸ“Š</span>æ¶ˆè²»åˆ†æ
        </button>
      </div>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background:#f8f9fa;">
        <section class="mb-6">
          <h2 class="text-lg font-bold mb-3" style="color:#2d3748;">æœ¬æœˆåˆ†é¡æ”¯å‡º</h2>
          <div id="category-stats" class="space-y-2"></div>
        </section>

        <section>
          <h2 class="text-lg font-bold mb-3" style="color:#2d3748;">æœ€è¿‘è¨˜éŒ„</h2>
          <div id="recent-records" class="space-y-2"></div>
          <p class="text-xs text-gray-400 mt-3">æç¤ºï¼šå¯å·¦æ»‘å¿«é€Ÿåˆªé™¤ï¼›æˆ–é» â‹¯ ç·¨è¼¯/åˆªé™¤</p>
        </section>
      </div>
    </div>

    <div id="analysis-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-analysis" class="tap-highlight text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">æ¶ˆè²»åˆ†æ</h1>
        <p class="text-white text-sm opacity-75 mt-1">æª¢è¦–æ‚¨çš„æ¶ˆè²»ç¿’æ…£èˆ‡çµ±è¨ˆ</p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background:#f8f9fa;">
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ“… ç¯©é¸æ¢ä»¶</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">æ™‚é–“å€é–“</label>
              <div class="grid grid-cols-2 gap-2">
                <input type="date" id="filter-start-date" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
                <input type="date" id="filter-end-date" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">æ¶ˆè²»ç”¨é€”</label>
              <select id="filter-category" class="w-full px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
                <option value="all">å…¨éƒ¨ç”¨é€”</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-700">é‡‘é¡ç¯„åœ</label>
              <div class="grid grid-cols-2 gap-2">
                <input type="number" id="filter-min-amount" placeholder="æœ€ä½é‡‘é¡" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
                <input type="number" id="filter-max-amount" placeholder="æœ€é«˜é‡‘é¡" class="px-3 py-2 rounded-lg border-2 text-sm" style="border-color:#e2e8f0;">
              </div>
            </div>

            <div class="flex gap-2">
              <button id="apply-filter-btn" class="tap-highlight flex-1 py-3 rounded-xl text-white font-semibold" style="background:#667eea;">å¥—ç”¨ç¯©é¸</button>
              <button id="reset-filter-btn" class="tap-highlight px-4 py-3 rounded-xl font-semibold" style="background:#e2e8f0;color:#4a5568;">é‡ç½®</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">ç¸½æ”¯å‡º</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-currency-1">NT$</span><span id="analysis-total">0</span></p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">ç­†æ•¸</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-count">0</span> ç­†</p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">å¹³å‡æ¶ˆè²»</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-currency-2">NT$</span><span id="analysis-average">0</span></p>
          </div>
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-sm text-gray-500 mb-1">æœ€é«˜å–®ç­†</p>
            <p class="text-2xl font-bold" style="color:#667eea;"><span id="analysis-currency-3">NT$</span><span id="analysis-max">0</span></p>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ“Š ç”¨é€”åˆ†å¸ƒ</h3>
          <div id="category-distribution" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm mb-4">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ’³ æ”¯ä»˜æ–¹å¼</h3>
          <div id="payment-distribution" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm">
          <h3 class="font-bold text-lg mb-4" style="color:#2d3748;">ğŸ“ æ¶ˆè²»æ˜ç´°</h3>
          <div id="analysis-records" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <div id="settings-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-settings" class="tap-highlight text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">è¼‰å…·è¨­å®š</h1>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background:#f8f9fa;">
        <div class="bg-white rounded-2xl p-6 shadow-sm mb-4">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background:#667eea;">ğŸ“±</div>
            <div>
              <h3 class="font-bold text-lg" style="color:#2d3748;">æ‰‹æ©Ÿæ¢ç¢¼è¼‰å…·</h3>
              <p class="text-xs text-gray-500">è¨­å®šå¾Œå°‡è‡ªå‹•é¡¯ç¤ºæ‚¨çš„è¼‰å…·æ¢ç¢¼</p>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-gray-700">è¼‰å…·è™Ÿç¢¼</label>
            <input type="text" id="carrier-number-input" placeholder="ä¾‹å¦‚: /ABC1234" class="w-full px-4 py-3 rounded-xl border-2 text-lg font-mono" style="border-color:#e2e8f0;" maxlength="8">
            <p class="text-xs text-gray-500 mt-2">è«‹è¼¸å…¥å®Œæ•´è¼‰å…·è™Ÿç¢¼ï¼ŒåŒ…å«é–‹é ­çš„ /</p>
          </div>

          <div id="carrier-preview" class="hidden mb-4">
            <p class="text-sm font-semibold mb-2 text-gray-700">é è¦½</p>
            <div class="bg-gray-50 rounded-xl p-4 border-2" style="border-color:#e2e8f0;">
              <div class="bg-white p-4 rounded-lg">
                <svg viewBox="0 0 200 60" class="w-full">
                  <rect x="5" y="5" width="2" height="50" fill="#000"/>
                  <rect x="10" y="5" width="3" height="50" fill="#000"/>
                  <rect x="16" y="5" width="2" height="50" fill="#000"/>
                  <rect x="21" y="5" width="4" height="50" fill="#000"/>
                  <rect x="28" y="5" width="2" height="50" fill="#000"/>
                  <rect x="33" y="5" width="5" height="50" fill="#000"/>
                  <rect x="41" y="5" width="2" height="50" fill="#000"/>
                  <rect x="46" y="5" width="3" height="50" fill="#000"/>
                  <rect x="52" y="5" width="2" height="50" fill="#000"/>
                  <rect x="57" y="5" width="4" height="50" fill="#000"/>
                </svg>
              </div>
              <p class="text-center text-sm font-mono mt-2" id="carrier-preview-text">/ABC1234</p>
            </div>
          </div>

          <button id="save-carrier-btn" class="tap-highlight w-full py-3 rounded-xl text-white font-semibold" style="background:#667eea;">
            <span id="save-carrier-text">å„²å­˜è¼‰å…·è¨­å®š</span>
          </button>
        </div>

        <div class="bg-blue-50 rounded-2xl p-4 border-2 border-blue-200">
          <div class="flex items-start gap-2">
            <span class="text-xl">â„¹ï¸</span>
            <div>
              <p class="text-sm font-semibold mb-1" style="color:#2d3748;">é—œæ–¼è¼‰å…·</p>
              <p class="text-xs text-gray-600">è¨­å®šå¾Œï¼Œæ¯æ¬¡è¨˜å¸³æ™‚æœƒè‡ªå‹•é¡¯ç¤ºæ‚¨çš„è¼‰å…·æ¢ç¢¼ã€‚<br>æ‚¨å¯ä»¥éš¨æ™‚å›åˆ°é€™è£¡ä¿®æ”¹è¼‰å…·è™Ÿç¢¼ã€‚</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="step1-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step1" class="tap-highlight text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é¸æ“‡æ¶ˆè²»ç”¨é€”</h1>
      </header>
      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background:#f8f9fa;">
        <div id="category-grid" class="grid grid-cols-3 gap-4 mb-6"></div>
        <button id="add-category-btn" class="tap-highlight w-full py-3 rounded-xl border-2 border-dashed text-gray-600 font-semibold" style="border-color:#cbd5e0;">
          <span class="text-xl mr-2">+</span>æ–°å¢åˆ†é¡
        </button>
        <div id="add-category-form" class="mt-4 hidden">
          <input type="text" id="new-category-input" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" class="w-full px-4 py-3 rounded-xl border-2 mb-3" style="border-color:#e2e8f0;">
          <div class="flex gap-2">
            <button id="save-category-btn" class="tap-highlight flex-1 py-3 rounded-xl text-white font-semibold" style="background:#667eea;">å„²å­˜</button>
            <button id="cancel-category-btn" class="tap-highlight flex-1 py-3 rounded-xl font-semibold" style="background:#e2e8f0;color:#4a5568;">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>

    <div id="step2-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step2" class="tap-highlight text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é›»å­ç™¼ç¥¨è¼‰å…·</h1>
        <p class="text-white text-sm opacity-75 mt-1" id="selected-category-display"></p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 flex flex-col" style="background:#f8f9fa;">
        <div class="flex-1 flex items-center justify-center mb-6">
          <div class="w-full max-w-sm bg-white rounded-2xl p-8 shadow-lg">
            <div class="text-center mb-4">
              <h3 class="text-lg font-bold mb-2" style="color:#2d3748;">æ‰‹æ©Ÿæ¢ç¢¼è¼‰å…·</h3>
              <p class="text-sm text-gray-500">è«‹å‡ºç¤ºæ­¤æ¢ç¢¼çµ¦åº—å“¡æƒæ</p>
            </div>
            <div class="bg-white p-6 rounded-xl border-2" style="border-color:#e2e8f0;">
              <svg viewBox="0 0 200 80" class="w-full">
                <rect x="5" y="10" width="3" height="60" fill="#000"/>
                <rect x="12" y="10" width="2" height="60" fill="#000"/>
                <rect x="18" y="10" width="4" height="60" fill="#000"/>
                <rect x="26" y="10" width="2" height="60" fill="#000"/>
                <rect x="32" y="10" width="6" height="60" fill="#000"/>
                <rect x="42" y="10" width="2" height="60" fill="#000"/>
                <rect x="48" y="10" width="4" height="60" fill="#000"/>
                <rect x="56" y="10" width="2" height="60" fill="#000"/>
                <rect x="62" y="10" width="3" height="60" fill="#000"/>
                <rect x="69" y="10" width="5" height="60" fill="#000"/>
                <rect x="78" y="10" width="2" height="60" fill="#000"/>
                <rect x="84" y="10" width="4" height="60" fill="#000"/>
                <rect x="92" y="10" width="2" height="60" fill="#000"/>
                <rect x="98" y="10" width="6" height="60" fill="#000"/>
                <rect x="108" y="10" width="3" height="60" fill="#000"/>
                <rect x="115" y="10" width="2" height="60" fill="#000"/>
                <rect x="121" y="10" width="5" height="60" fill="#000"/>
                <rect x="130" y="10" width="2" height="60" fill="#000"/>
                <rect x="136" y="10" width="4" height="60" fill="#000"/>
                <rect x="144" y="10" width="3" height="60" fill="#000"/>
                <rect x="151" y="10" width="2" height="60" fill="#000"/>
                <rect x="157" y="10" width="6" height="60" fill="#000"/>
                <rect x="167" y="10" width="2" height="60" fill="#000"/>
                <rect x="173" y="10" width="4" height="60" fill="#000"/>
                <rect x="181" y="10" width="3" height="60" fill="#000"/>
                <rect x="188" y="10" width="2" height="60" fill="#000"/>
              </svg>
            </div>
            <p class="text-center text-xs text-gray-400 mt-3" id="carrier-display-text">/ABC1234</p>
          </div>
        </div>
        <div class="space-y-3">
          <button id="skip-carrier-btn" class="tap-highlight w-full py-4 rounded-xl font-semibold" style="background:#e2e8f0;color:#4a5568;">è·³éè¼‰å…·ï¼Œç›´æ¥ä»˜æ¬¾</button>
          <button id="continue-to-payment-btn" class="tap-highlight w-full py-4 rounded-xl text-white font-semibold" style="background:#667eea;">ä½¿ç”¨è¼‰å…·å¾Œç¹¼çºŒ</button>
        </div>
      </div>
    </div>

    <div id="step3-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step3" class="tap-highlight text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">é¸æ“‡æ”¯ä»˜æ–¹å¼</h1>
        <p class="text-white text-sm opacity-75 mt-1" id="selected-category-display2"></p>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 overflow-auto" style="background:#f8f9fa;">
        <div class="space-y-3 mb-6">
          <button class="payment-method-btn tap-highlight w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="LINE Pay" data-color="#00B900" data-emoji="ğŸ’š">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#00B900;">ğŸ’š</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">LINE Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn tap-highlight w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="Taiwan Pay" data-color="#0066CC" data-emoji="ğŸ¦">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#0066CC;">ğŸ¦</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">Taiwan Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn tap-highlight w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="å…¨æ”¯ä»˜" data-color="#FF6B00" data-emoji="ğŸ”¶">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#FF6B00;">ğŸ”¶</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">å…¨æ”¯ä»˜ PX Pay</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn tap-highlight w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="è¡—å£æ”¯ä»˜" data-color="#FF3B3B" data-emoji="ğŸª">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#FF3B3B;">ğŸª</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">è¡—å£æ”¯ä»˜</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn tap-highlight w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="æ‚ éŠä»˜" data-color="#0088FF" data-emoji="ğŸš‡">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#0088FF;">ğŸš‡</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">æ‚ éŠä»˜</div>
                <div class="text-xs text-gray-500">Deep Link è·³è½‰</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>

          <button class="payment-method-btn tap-highlight w-full p-5 rounded-2xl bg-white shadow-sm flex items-center justify-between" data-method="ç¾é‡‘" data-color="#48BB78" data-emoji="ğŸ’µ">
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mr-4" style="background:#48BB78;">ğŸ’µ</div>
              <div>
                <div class="font-semibold text-lg text-left" style="color:#2d3748;">ç¾é‡‘</div>
                <div class="text-xs text-gray-500">æ‰‹å‹•è¼¸å…¥é‡‘é¡</div>
              </div>
            </div>
            <span class="text-gray-400">â†’</span>
          </button>
        </div>
      </div>
    </div>

    <div id="payment-redirect-screen" class="h-full flex-col hidden" style="background:#000;">
      <div class="flex-1 flex items-center justify-center px-6">
        <div class="text-center">
          <div class="relative inline-block mb-8">
            <div class="absolute inset-0 w-32 h-32 rounded-full pulse-ring" id="pulse-ring" style="background:rgba(0,185,0,.3);"></div>
            <div class="w-32 h-32 rounded-3xl mx-auto flex items-center justify-center text-6xl shadow-2xl relative z-10" id="redirect-payment-icon" style="background:#00B900;">ğŸ’š</div>
          </div>
          <h2 class="text-white text-2xl font-bold mb-3" id="redirect-payment-name">LINE Pay</h2>
          <p class="text-white text-lg opacity-75 mb-8">æ­£åœ¨å•Ÿå‹•æ”¯ä»˜ APP...</p>
          <div class="flex justify-center space-x-2 mb-8">
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay:0s;"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay:.2s;"></div>
            <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay:.4s;"></div>
          </div>
          <div class="bg-white bg-opacity-10 rounded-2xl p-4 backdrop-blur-lg max-w-sm mx-auto">
            <p class="text-white text-xs opacity-75 mb-2">ğŸ”— Deep Link URL</p>
            <p class="text-white text-xs font-mono break-all opacity-50" id="deep-link-url">line://pay/generateQR</p>
          </div>
          <div class="mt-6 space-y-3">
            <button id="manual-open-deeplink-btn" class="tap-highlight w-full max-w-sm mx-auto py-3 rounded-xl text-white font-semibold" style="background:rgba(255,255,255,.12);backdrop-filter:blur(10px);">æ‰‹å‹•é–‹å•Ÿæ”¯ä»˜ App</button>
            <button id="back-from-redirect" class="tap-highlight w-full max-w-sm mx-auto py-3 rounded-xl font-semibold" style="background:#e2e8f0;color:#4a5568;">è¿”å›é¸æ“‡æ”¯ä»˜æ–¹å¼</button>
          </div>
        </div>
      </div>
    </div>

    <div id="external-payment-screen" class="h-full flex-col hidden">
      <div class="px-6 py-6" id="external-payment-header" style="background:#00B900;">
        <div class="flex items-center justify-between mb-4">
          <span class="text-white text-sm">â— 9:41</span>
          <div class="flex gap-1">
            <div class="w-1 h-3 bg-white rounded-full"></div>
            <div class="w-1 h-3 bg-white rounded-full"></div>
            <div class="w-1 h-3 bg-white rounded-full"></div>
            <div class="w-1 h-3 bg-white rounded-full opacity-30"></div>
          </div>
        </div>
        <h1 class="text-white text-2xl font-bold mb-1" id="external-app-title">LINE Pay</h1>
        <p class="text-white text-sm opacity-75">ä»˜æ¬¾ç¢ºèª</p>
      </div>

      <div class="flex-1 flex flex-col" style="background:#f0f0f0;">
        <div class="flex-1 flex flex-col items-center justify-center px-6 py-8">
          <div class="w-full max-w-sm bg-white rounded-3xl p-8 shadow-xl mb-6">
            <div class="text-center mb-6">
              <div class="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl" id="external-icon" style="background:#f0f0f0;">ğŸ’š</div>
              <p class="text-sm text-gray-500 mb-3">ä»˜æ¬¾é‡‘é¡</p>
              <div class="mb-6">
                <input type="number" id="external-amount-input" placeholder="è«‹è¼¸å…¥é‡‘é¡" class="text-5xl font-bold text-center border-0 outline-none bg-transparent w-full" style="color:#2d3748;" inputmode="decimal" value="">
                <div class="flex items-center justify-center mt-2"><span class="text-lg text-gray-400">NT$</span></div>
              </div>
              <div class="bg-gray-50 rounded-xl p-4 mb-4">
                <p class="text-xs text-gray-500 mb-1">ä»˜æ¬¾ç”¨é€”</p>
                <p class="text-base font-semibold" style="color:#2d3748;" id="external-payment-category">æ—©é¤</p>
              </div>
            </div>
            <div class="space-y-3 border-t pt-4" style="border-color:#e2e8f0;">
              <div class="flex justify-between text-sm py-1"><span class="text-gray-500">å¯ç”¨é¤˜é¡</span><span class="font-semibold text-green-600">NT$ 8,520</span></div>
              <div class="flex justify-between text-sm py-1"><span class="text-gray-500">ä»˜æ¬¾å¾Œé¤˜é¡</span><span class="font-semibold" style="color:#2d3748;" id="remaining-balance">NT$ 8,520</span></div>
            </div>
          </div>

          <button id="confirm-external-payment-btn" class="tap-highlight w-full max-w-sm py-5 rounded-2xl text-white text-lg font-bold shadow-lg mb-3" style="background:#00B900;">
            <span id="confirm-btn-text">ç¢ºèªä»˜æ¬¾</span>
          </button>
          <button id="cancel-external-payment-btn" class="tap-highlight w-full max-w-sm py-4 rounded-2xl font-semibold" style="background:#e2e8f0;color:#666;">å–æ¶ˆ</button>
        </div>

        <div class="px-6 py-4 bg-white border-t" style="border-color:#e2e8f0;">
          <div class="flex items-start gap-2">
            <span class="text-lg">ğŸ”’</span>
            <div>
              <p class="text-xs font-semibold mb-1" style="color:#2d3748;">å®‰å…¨æç¤º</p>
              <p class="text-xs text-gray-500">æœ¬ç•«é¢ç‚ºæ¨¡æ“¬ç¤ºç¯„ï½œå¯¦éš›ä½¿ç”¨æ™‚æœƒåœ¨çœŸå¯¦çš„æ”¯ä»˜ APP ä¸­å®Œæˆä»˜æ¬¾</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="payment-success-screen" class="h-full flex-col hidden">
      <div class="flex-1 flex items-center justify-center px-6" style="background:linear-gradient(135deg,#48BB78 0%,#38A169 100%);">
        <div class="text-center">
          <div class="relative inline-block mb-8">
            <div class="absolute inset-0 w-32 h-32 rounded-full bg-white opacity-20 animate-ping"></div>
            <div class="w-32 h-32 rounded-full mx-auto flex items-center justify-center bg-white shadow-2xl relative z-10"><span class="text-7xl">âœ“</span></div>
          </div>
          <h2 class="text-white text-3xl font-bold mb-3">ä»˜æ¬¾æˆåŠŸï¼</h2>
          <div class="bg-white bg-opacity-20 rounded-2xl px-8 py-5 mb-6 backdrop-blur-lg">
            <p class="text-white text-sm opacity-90 mb-2">å·²ä»˜æ¬¾</p>
            <p class="text-white text-5xl font-bold mb-1"><span id="success-currency">NT$</span><span id="success-amount">0</span></p>
            <p class="text-white text-xs opacity-75 mt-2" id="success-category">æ—©é¤</p>
          </div>
          <div class="mb-6">
            <p class="text-white text-base opacity-90 mb-3">æ­£åœ¨è¿”å›è¨˜å¸³ APP...</p>
            <div class="flex justify-center space-x-2">
              <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay:.2s;"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay:.4s;"></div>
            </div>
          </div>
          <div class="bg-white bg-opacity-10 rounded-xl p-3 backdrop-blur-lg max-w-sm mx-auto">
            <p class="text-white text-xs opacity-75">âœ¨ é‡‘é¡å·²è‡ªå‹•å›å¡«ä¸¦å„²å­˜åˆ°æ‚¨çš„è¨˜å¸³æœ¬</p>
          </div>
        </div>
      </div>
    </div>

    <div id="step4-screen" class="h-full flex-col hidden">
      <header class="px-6 pt-8 pb-6">
        <button id="back-from-step4" class="tap-highlight text-white text-2xl mb-4">â†</button>
        <h1 class="text-white text-2xl font-bold">è¼¸å…¥é‡‘é¡</h1>
        <div class="mt-3 text-white text-sm opacity-90">
          <p>åˆ†é¡: <span id="final-category-display" class="font-semibold"></span></p>
          <p>æ”¯ä»˜: <span id="final-payment-display" class="font-semibold"></span></p>
        </div>
      </header>

      <div class="flex-1 rounded-t-3xl px-6 py-6 flex flex-col" style="background:#f8f9fa;">
        <div class="flex-1 flex flex-col justify-center mb-6">
          <div class="text-center mb-8">
            <div class="flex items-baseline justify-center">
              <span id="currency-symbol-input" class="text-3xl text-gray-600 mr-2">NT$</span>
              <input type="number" id="amount-input" placeholder="0" class="text-6xl font-bold text-center border-0 outline-none bg-transparent w-full" style="color:#2d3748;" inputmode="decimal">
            </div>
          </div>

          <div class="bg-white rounded-2xl p-4 shadow-sm">
            <label class="block text-sm font-semibold mb-2 text-gray-700">å‚™è¨» (é¸å¡«)</label>
            <textarea id="note-input" placeholder="æ–°å¢å‚™è¨»..." class="w-full px-4 py-3 rounded-xl border-2 resize-none" style="border-color:#e2e8f0;" rows="3"></textarea>
          </div>
        </div>

        <button id="save-expense-btn" class="tap-highlight w-full py-4 rounded-xl text-white font-semibold text-lg shadow-lg" style="background:#667eea;">
          <span id="save-btn-text">å„²å­˜è¨˜éŒ„</span>
        </button>
      </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 z-50">
      <div id="edit-modal-backdrop" class="absolute inset-0 modal-backdrop"></div>
      <div class="absolute inset-x-0 bottom-0 sheet bg-white p-5 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold" style="color:#2d3748;">ç·¨è¼¯è¨˜éŒ„</h3>
          <button id="close-edit-modal" class="tap-highlight w-10 h-10 rounded-full bg-gray-100 text-xl flex items-center justify-center">âœ•</button>
        </div>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">ç”¨é€”</label>
            <select id="edit-category" class="w-full px-3 py-3 rounded-xl border-2 text-base" style="border-color:#e2e8f0;"></select>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">æ”¯ä»˜æ–¹å¼</label>
            <select id="edit-payment-method" class="w-full px-3 py-3 rounded-xl border-2 text-base" style="border-color:#e2e8f0;">
              <option value="ç¾é‡‘">ç¾é‡‘</option>
              <option value="LINE Pay">LINE Pay</option>
              <option value="Taiwan Pay">Taiwan Pay</option>
              <option value="å…¨æ”¯ä»˜">å…¨æ”¯ä»˜</option>
              <option value="è¡—å£æ”¯ä»˜">è¡—å£æ”¯ä»˜</option>
              <option value="æ‚ éŠä»˜">æ‚ éŠä»˜</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">é‡‘é¡</label>
            <input id="edit-amount" type="number" inputmode="decimal" class="w-full px-4 py-3 rounded-xl border-2 text-lg font-semibold" style="border-color:#e2e8f0;" placeholder="0">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">æ—¥æœŸæ™‚é–“</label>
            <input id="edit-datetime" type="datetime-local" class="w-full px-4 py-3 rounded-xl border-2 text-base" style="border-color:#e2e8f0;">
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2 text-gray-700">å‚™è¨»</label>
            <textarea id="edit-note" class="w-full px-4 py-3 rounded-xl border-2 resize-none" style="border-color:#e2e8f0;" rows="2" placeholder="(é¸å¡«)"></textarea>
          </div>

          <div class="flex gap-2 pt-2">
            <button id="delete-record-btn" class="tap-highlight flex-1 py-3 rounded-xl font-semibold" style="background:#fee2e2;color:#b91c1c;">åˆªé™¤</button>
            <button id="save-edit-btn" class="tap-highlight flex-1 py-3 rounded-xl text-white font-semibold" style="background:#667eea;">å„²å­˜</button>
          </div>
          <p class="text-xs text-gray-400">åˆªé™¤ç‚ºè»Ÿåˆªé™¤ï¼ˆä¸é¡¯ç¤ºæ–¼åˆ—è¡¨ï¼‰ï¼Œå¯é¿å…è³‡æ–™ SDK ä¸æ”¯æ´çœŸåˆªé™¤é€ æˆéŒ¯èª¤ã€‚</p>
        </div>
      </div>
    </div>

    <div id="confirm-delete-modal" class="hidden fixed inset-0 z-50">
      <div class="absolute inset-0 modal-backdrop"></div>
      <div class="absolute inset-x-0 bottom-0 sheet bg-white p-5 shadow-2xl">
        <h3 class="text-lg font-bold mb-2" style="color:#2d3748;">ç¢ºå®šè¦åˆªé™¤ï¼Ÿ</h3>
        <p class="text-sm text-gray-600 mb-4">åˆªé™¤å¾Œé€™ç­†è¨˜éŒ„å°‡ä¸æœƒå†å‡ºç¾åœ¨åˆ—è¡¨ä¸­ã€‚</p>
        <div class="flex gap-2">
          <button id="cancel-delete-confirm-btn" class="tap-highlight flex-1 py-3 rounded-xl font-semibold" style="background:#e2e8f0;color:#4a5568;">å–æ¶ˆ</button>
          <button id="confirm-delete-btn" class="tap-highlight flex-1 py-3 rounded-xl text-white font-semibold" style="background:#ef4444;">åˆªé™¤</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const defaultConfig={app_title:"æ™ºæ…§è¨˜å¸³",currency_symbol:"NT$"};

    let allRecords=[];
    let carrierSettings=null;
    let currentFlow={category:"",paymentMethod:"",paymentColor:"",paymentEmoji:"",carrierUsed:false,pendingAmount:0};

    const defaultCategories=["æ—©é¤","åˆé¤","æ™šé¤","äº¤é€š","å¨›æ¨‚","è³¼ç‰©","å…¶ä»–"];
    let customCategories=[];

    let analysisFilters={startDate:null,endDate:null,category:"all",minAmount:null,maxAmount:null};

    let editingRecordId=null;

    const dataHandler={
      onDataChanged(data){
        const settings=data.find(r=>r && r.is_settings===true);
        const expenses=data.filter(r=>r && r.is_settings!==true && r.is_deleted!==true);
        carrierSettings=settings||null;
        allRecords=expenses.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
        updateUI();
        updateCarrierDisplay();
        refreshAnalysisIfVisible();
      }
    };

    async function onConfigChange(config){
      document.querySelectorAll("#app-title").forEach(el=>el.textContent=config.app_title||defaultConfig.app_title);
      document.querySelectorAll("#currency-symbol,#currency-symbol-input,#success-currency,#analysis-currency-1,#analysis-currency-2,#analysis-currency-3").forEach(el=>{
        el.textContent=config.currency_symbol||defaultConfig.currency_symbol
      });
    }

    function showScreen(screenId){
      const screens=["main-screen","analysis-screen","settings-screen","step1-screen","step2-screen","step3-screen","step4-screen","payment-redirect-screen","external-payment-screen","payment-success-screen"];
      screens.forEach(id=>{
        const screen=document.getElementById(id);
        if(!screen) return;
        if(id===screenId){
          screen.classList.remove("hidden");
          screen.classList.add("flex","fade-in");
        }else{
          screen.classList.add("hidden");
          screen.classList.remove("flex");
        }
      });
    }

    function showSuccessMessage(message){
      const div=document.createElement("div");
      div.textContent=message;
      div.className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50";
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),2000);
    }

    function showErrorMessage(message){
      const div=document.createElement("div");
      div.textContent=message;
      div.className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-xl shadow-lg z-50";
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),2000);
    }

    function updateCarrierDisplay(){
      if(carrierSettings && carrierSettings.carrier_number){
        const t=carrierSettings.carrier_number;
        document.getElementById("carrier-display-text").textContent=t;
        document.getElementById("carrier-number-input").value=t;
        document.getElementById("carrier-preview-text").textContent=t;
        document.getElementById("carrier-preview").classList.remove("hidden");
      }else{
        document.getElementById("carrier-display-text").textContent="/ABC1234";
        document.getElementById("carrier-number-input").value="";
        document.getElementById("carrier-preview").classList.add("hidden");
      }
    }

    function updateUI(){
      updateTotalAmount();
      updateCategoryStats();
      updateRecentRecords();
    }

    function updateTotalAmount(){
      const total=allRecords.reduce((sum,r)=>sum+(r.amount||0),0);
      document.getElementById("total-amount").textContent=total.toLocaleString();
    }

    function updateCategoryStats(){
      const statsContainer=document.getElementById("category-stats");
      const totals={};
      allRecords.forEach(r=>{
        if(!r.category) return;
        totals[r.category]=(totals[r.category]||0)+(r.amount||0);
      });
      const sorted=Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,5);
      if(sorted.length===0){
        statsContainer.innerHTML='<p class="text-gray-500 text-center py-4">å°šç„¡æ¶ˆè²»è¨˜éŒ„</p>';
        return;
      }
      const maxAmount=Math.max(...sorted.map(x=>x[1]));
      statsContainer.innerHTML=sorted.map(([category,amount])=>{
        const pct=(amount/maxAmount)*100;
        return `
          <div class="bg-white rounded-xl p-4 shadow-sm">
            <div class="flex justify-between mb-2">
              <span class="font-semibold" style="color:#2d3748;">${category}</span>
              <span class="font-bold" style="color:#667eea;">${(window.elementSdk?.config?.currency_symbol||defaultConfig.currency_symbol)}${amount.toLocaleString()}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="h-2 rounded-full" style="width:${pct}%;background:#667eea;"></div>
            </div>
          </div>
        `;
      }).join("");
    }

    function toLocalDateTimeInputValue(iso){
      try{
        const d=new Date(iso);
        const pad=n=>String(n).padStart(2,"0");
        const yyyy=d.getFullYear();
        const mm=pad(d.getMonth()+1);
        const dd=pad(d.getDate());
        const hh=pad(d.getHours());
        const mi=pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }catch(e){
        return "";
      }
    }

    function updateRecentRecords(){
      const container=document.getElementById("recent-records");
      const recent=allRecords.slice(0,10);
      if(recent.length===0){
        container.innerHTML='<p class="text-gray-500 text-center py-4">å°šç„¡æ¶ˆè²»è¨˜éŒ„</p>';
        return;
      }

      container.innerHTML=recent.map(r=>{
        const date=new Date(r.timestamp);
        const timeStr=`${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,"0")}:${String(date.getMinutes()).padStart(2,"0")}`;
        const id=r.id||"";
        const noteHtml=r.note?`<div class="text-sm text-gray-400 mt-1">${r.note}</div>`:"";
        return `
          <div class="swipe-row bg-white shadow-sm" data-id="${id}">
            <div class="swipe-actions">
              <button class="tap-highlight swipe-delete-btn w-20 h-10 rounded-xl text-white font-semibold" style="background:#ef4444;" data-id="${id}">åˆªé™¤</button>
            </div>
            <div class="swipe-content rounded-xl p-4">
              <div class="flex justify-between items-start gap-3">
                <div class="flex-1">
                  <div class="font-semibold text-lg mb-1" style="color:#2d3748;">${r.category||""}</div>
                  <div class="text-sm text-gray-500">${r.payment_method||""} Â· ${timeStr}</div>
                  ${noteHtml}
                </div>
                <div class="flex flex-col items-end gap-2">
                  <div class="text-xl font-bold" style="color:#667eea;">${(window.elementSdk?.config?.currency_symbol||defaultConfig.currency_symbol)}${(r.amount||0).toLocaleString()}</div>
                  <button class="tap-highlight record-menu-btn w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl" data-id="${id}">â‹¯</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      document.querySelectorAll(".record-menu-btn").forEach(btn=>{
        btn.addEventListener("click",()=>openEditModal(btn.dataset.id));
      });

      document.querySelectorAll(".swipe-delete-btn").forEach(btn=>{
        btn.addEventListener("click",()=>promptDelete(btn.dataset.id));
      });

      setupSwipeToDelete(container);
    }

    function setupSwipeToDelete(container){
      let openedRow=null;

      const closeOpened=()=>{
        if(openedRow){
          openedRow.classList.remove("swipe-revealed");
          openedRow=null;
        }
      };

      container.querySelectorAll(".swipe-row").forEach(row=>{
        let startX=0,startY=0,dragging=false;
        const threshold=40;

        const onStart=(e)=>{
          const t=e.touches?e.touches[0]:e;
          startX=t.clientX;
          startY=t.clientY;
          dragging=true;
        };

        const onMove=(e)=>{
          if(!dragging) return;
          const t=e.touches?e.touches[0]:e;
          const dx=t.clientX-startX;
          const dy=t.clientY-startY;
          if(Math.abs(dy)>Math.abs(dx)) return;
          if(dx<-threshold){
            if(openedRow && openedRow!==row) closeOpened();
            row.classList.add("swipe-revealed");
            openedRow=row;
          }
          if(dx>threshold){
            row.classList.remove("swipe-revealed");
            if(openedRow===row) openedRow=null;
          }
        };

        const onEnd=()=>{
          dragging=false;
        };

        row.addEventListener("touchstart",onStart,{passive:true});
        row.addEventListener("touchmove",onMove,{passive:true});
        row.addEventListener("touchend",onEnd,{passive:true});

        row.addEventListener("click",(e)=>{
          const isBtn=e.target.closest("button");
          if(!isBtn && row.classList.contains("swipe-revealed")){
            row.classList.remove("swipe-revealed");
            if(openedRow===row) openedRow=null;
          }
        });
      });

      document.addEventListener("touchstart",(e)=>{
        const inside=e.target.closest(".swipe-row");
        if(!inside) closeOpened();
      },{passive:true});
    }

    function renderCategoryGrid(){
      const grid=document.getElementById("category-grid");
      const all=[...defaultCategories,...customCategories];
      grid.innerHTML=all.map(c=>`
        <button class="tap-highlight category-btn p-6 rounded-2xl bg-white shadow-sm text-center font-semibold transition-all hover:shadow-md" data-category="${c}" style="color:#2d3748;">
          ${getCategoryEmoji(c)}<br><span class="text-sm">${c}</span>
        </button>
      `).join("");

      document.querySelectorAll(".category-btn").forEach(btn=>{
        btn.addEventListener("click",()=>{
          currentFlow.category=btn.dataset.category;
          document.getElementById("selected-category-display").textContent=`åˆ†é¡: ${currentFlow.category}`;
          document.getElementById("selected-category-display2").textContent=`åˆ†é¡: ${currentFlow.category}`;
          document.getElementById("final-category-display").textContent=currentFlow.category;
          document.getElementById("external-payment-category").textContent=currentFlow.category;
          document.getElementById("success-category").textContent=currentFlow.category;
          showScreen("step2-screen");
        });
      });
    }

    function getCategoryEmoji(category){
      const map={æ—©é¤:"ğŸ³",åˆé¤:"ğŸ±",æ™šé¤:"ğŸ½ï¸",äº¤é€š:"ğŸš—",å¨›æ¨‚:"ğŸ®",è³¼ç‰©:"ğŸ›ï¸",å…¶ä»–:"ğŸ“"};
      return map[category]||"ğŸ’°";
    }

    function initializeAnalysisFilters(){
      const now=new Date();
      const firstDay=new Date(now.getFullYear(),now.getMonth(),1);
      const lastDay=new Date(now.getFullYear(),now.getMonth()+1,0);
      const fmt=(d)=>{
        const y=d.getFullYear();
        const m=String(d.getMonth()+1).padStart(2,"0");
        const day=String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${day}`;
      };

      document.getElementById("filter-start-date").value=fmt(firstDay);
      document.getElementById("filter-end-date").value=fmt(lastDay);
      document.getElementById("filter-min-amount").value="";
      document.getElementById("filter-max-amount").value="";
      document.getElementById("filter-category").value="all";

      analysisFilters={startDate:fmt(firstDay),endDate:fmt(lastDay),category:"all",minAmount:null,maxAmount:null};
      updateCategoryFilter();
      performAnalysis();
    }

    function updateCategoryFilter(){
      const select=document.getElementById("filter-category");
      const set=new Set();
      allRecords.forEach(r=>{ if(r.category) set.add(r.category) });
      select.innerHTML='<option value="all">å…¨éƒ¨ç”¨é€”</option>';
      Array.from(set).sort().forEach(c=>{
        const o=document.createElement("option");
        o.value=c;o.textContent=c;
        select.appendChild(o);
      });
    }

    function getFilteredRecords(){
      return allRecords.filter(r=>{
        const recordDate=new Date(r.timestamp).toISOString().split("T")[0];
        if(analysisFilters.startDate && recordDate<analysisFilters.startDate) return false;
        if(analysisFilters.endDate && recordDate>analysisFilters.endDate) return false;
        if(analysisFilters.category!=="all" && r.category!==analysisFilters.category) return false;
        if(analysisFilters.minAmount && (r.amount||0)<analysisFilters.minAmount) return false;
        if(analysisFilters.maxAmount && (r.amount||0)>analysisFilters.maxAmount) return false;
        return true;
      });
    }

    function refreshAnalysisIfVisible(){
      const analysisScreen=document.getElementById("analysis-screen");
      if(analysisScreen && !analysisScreen.classList.contains("hidden")){
        updateCategoryFilter();
        performAnalysis();
      }
    }

    function performAnalysis(){
      const filtered=getFilteredRecords();
      const total=filtered.reduce((sum,r)=>sum+(r.amount||0),0);
      const count=filtered.length;
      const average=count>0?Math.round(total/count):0;
      const max=count>0?Math.max(...filtered.map(r=>r.amount||0)):0;

      document.getElementById("analysis-total").textContent=total.toLocaleString();
      document.getElementById("analysis-count").textContent=count;
      document.getElementById("analysis-average").textContent=average.toLocaleString();
      document.getElementById("analysis-max").textContent=max.toLocaleString();

      const categoryStats={};
      filtered.forEach(r=>{
        categoryStats[r.category]=(categoryStats[r.category]||0)+(r.amount||0);
      });
      const sortedCats=Object.entries(categoryStats).sort((a,b)=>b[1]-a[1]);
      const categoryContainer=document.getElementById("category-distribution");
      if(sortedCats.length===0){
        categoryContainer.innerHTML='<p class="text-gray-500 text-center py-2">ç„¡è³‡æ–™</p>';
      }else{
        const maxCat=Math.max(...sortedCats.map(x=>x[1]));
        categoryContainer.innerHTML=sortedCats.map(([category,amount])=>{
          const pct=(amount/maxCat)*100;
          const proportion=total>0?((amount/total)*100).toFixed(1):"0.0";
          return `
            <div>
              <div class="flex justify-between mb-1 text-sm">
                <span class="font-semibold" style="color:#2d3748;">${category}</span>
                <span class="text-gray-600">${(window.elementSdk?.config?.currency_symbol||defaultConfig.currency_symbol)}${amount.toLocaleString()} (${proportion}%)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full" style="width:${pct}%;background:#667eea;"></div>
              </div>
            </div>
          `;
        }).join("");
      }

      const paymentStats={};
      filtered.forEach(r=>{
        const m=r.payment_method||"";
        if(!paymentStats[m]) paymentStats[m]={count:0,amount:0};
        paymentStats[m].count++;
        paymentStats[m].amount+=(r.amount||0);
      });
      const sortedPay=Object.entries(paymentStats).sort((a,b)=>b[1].amount-a[1].amount);
      const paymentContainer=document.getElementById("payment-distribution");
      if(sortedPay.length===0){
        paymentContainer.innerHTML='<p class="text-gray-500 text-center py-2">ç„¡è³‡æ–™</p>';
      }else{
        paymentContainer.innerHTML=sortedPay.map(([method,stats])=>{
          const proportion=total>0?((stats.amount/total)*100).toFixed(1):"0.0";
          return `
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <div>
                <p class="font-semibold" style="color:#2d3748;">${method}</p>
                <p class="text-xs text-gray-500">${stats.count} ç­†äº¤æ˜“</p>
              </div>
              <div class="text-right">
                <p class="font-bold" style="color:#667eea;">${(window.elementSdk?.config?.currency_symbol||defaultConfig.currency_symbol)}${stats.amount.toLocaleString()}</p>
                <p class="text-xs text-gray-500">${proportion}%</p>
              </div>
            </div>
          `;
        }).join("");
      }

      const recordsContainer=document.getElementById("analysis-records");
      if(filtered.length===0){
        recordsContainer.innerHTML='<p class="text-gray-500 text-center py-4">ç„¡ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>';
      }else{
        recordsContainer.innerHTML=filtered.slice(0,20).map(r=>{
          const date=new Date(r.timestamp);
          const dateStr=`${date.getMonth()+1}/${date.getDate()}`;
          const timeStr=`${String(date.getHours()).padStart(2,"0")}:${String(date.getMinutes()).padStart(2,"0")}`;
          const id=r.id||"";
          return `
            <div class="flex justify-between items-start py-3 border-b border-gray-100 gap-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-semibold" style="color:#2d3748;">${r.category}</span>
                  <span class="text-xs px-2 py-1 rounded" style="background:#f0f0f0;color:#666;">${r.payment_method}</span>
                </div>
                <p class="text-xs text-gray-500">${dateStr} ${timeStr}</p>
                ${r.note?`<p class="text-xs text-gray-400 mt-1">${r.note}</p>`:""}
              </div>
              <div class="flex flex-col items-end gap-2">
                <div class="text-lg font-bold" style="color:#667eea;">${(window.elementSdk?.config?.currency_symbol||defaultConfig.currency_symbol)}${(r.amount||0).toLocaleString()}</div>
                <button class="tap-highlight analysis-record-menu-btn w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl" data-id="${id}">â‹¯</button>
              </div>
            </div>
          `;
        }).join("");

        if(filtered.length>20){
          recordsContainer.innerHTML+='<p class="text-gray-500 text-center py-3 text-sm">åƒ…é¡¯ç¤ºå‰ 20 ç­†è¨˜éŒ„</p>';
        }

        document.querySelectorAll(".analysis-record-menu-btn").forEach(btn=>{
          btn.addEventListener("click",()=>openEditModal(btn.dataset.id));
        });
      }
    }

    function getRecordById(id){
      return allRecords.find(r=>String(r.id)===String(id))||null;
    }

    function buildEditCategoryOptions(selected){
      const select=document.getElementById("edit-category");
      const set=new Set([...defaultCategories,...customCategories]);
      allRecords.forEach(r=>{ if(r.category) set.add(r.category) });
      select.innerHTML="";
      Array.from(set).filter(Boolean).sort().forEach(c=>{
        const o=document.createElement("option");
        o.value=c;o.textContent=c;
        select.appendChild(o);
      });
      if(selected && Array.from(select.options).some(o=>o.value===selected)){
        select.value=selected;
      }
    }

    function openEditModal(id){
      const record=getRecordById(id);
      if(!record){
        showErrorMessage("æ‰¾ä¸åˆ°é€™ç­†è¨˜éŒ„");
        return;
      }
      editingRecordId=id;

      buildEditCategoryOptions(record.category);
      document.getElementById("edit-payment-method").value=record.payment_method||"ç¾é‡‘";
      document.getElementById("edit-amount").value=record.amount||0;
      document.getElementById("edit-note").value=record.note||"";
      document.getElementById("edit-datetime").value=toLocalDateTimeInputValue(record.timestamp);

      document.getElementById("edit-modal").classList.remove("hidden");
    }

    function closeEditModal(){
      editingRecordId=null;
      document.getElementById("edit-modal").classList.add("hidden");
    }

    function promptDelete(id){
      editingRecordId=id;
      document.getElementById("confirm-delete-modal").classList.remove("hidden");
    }

    function closeDeleteConfirm(){
      document.getElementById("confirm-delete-modal").classList.add("hidden");
    }

    document.getElementById("close-edit-modal").addEventListener("click",closeEditModal);
    document.getElementById("edit-modal-backdrop").addEventListener("click",closeEditModal);

    document.getElementById("delete-record-btn").addEventListener("click",()=>{
      if(!editingRecordId) return;
      document.getElementById("confirm-delete-modal").classList.remove("hidden");
    });

    document.getElementById("cancel-delete-confirm-btn").addEventListener("click",closeDeleteConfirm);

    document.getElementById("confirm-delete-btn").addEventListener("click",async()=>{
      const id=editingRecordId;
      if(!id) return;
      const record=getRecordById(id);
      if(!record){
        closeDeleteConfirm();
        closeEditModal();
        showErrorMessage("æ‰¾ä¸åˆ°é€™ç­†è¨˜éŒ„");
        return;
      }
      const updated={...record,is_deleted:true};
      const res=await window.dataSdk.update(updated);
      closeDeleteConfirm();
      closeEditModal();
      if(res?.isOk){
        showSuccessMessage("âœ“ å·²åˆªé™¤");
        refreshAnalysisIfVisible();
      }else{
        showErrorMessage("åˆªé™¤å¤±æ•—");
      }
    });

    document.getElementById("save-edit-btn").addEventListener("click",async()=>{
      const id=editingRecordId;
      if(!id) return;
      const record=getRecordById(id);
      if(!record){
        showErrorMessage("æ‰¾ä¸åˆ°é€™ç­†è¨˜éŒ„");
        return;
      }

      const category=document.getElementById("edit-category").value.trim();
      const payment_method=document.getElementById("edit-payment-method").value;
      const amount=parseFloat(document.getElementById("edit-amount").value);
      const note=document.getElementById("edit-note").value.trim();
      const dtLocal=document.getElementById("edit-datetime").value;

      if(!category){
        showErrorMessage("è«‹é¸æ“‡ç”¨é€”");
        return;
      }
      if(!amount || amount<=0){
        showErrorMessage("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
        return;
      }
      if(!dtLocal){
        showErrorMessage("è«‹é¸æ“‡æ—¥æœŸæ™‚é–“");
        return;
      }

      const ts=new Date(dtLocal);
      if(Number.isNaN(ts.getTime())){
        showErrorMessage("æ—¥æœŸæ™‚é–“æ ¼å¼ä¸æ­£ç¢º");
        return;
      }

      const updated={
        ...record,
        category,
        payment_method,
        amount,
        note,
        timestamp:ts.toISOString()
      };

      const btn=document.getElementById("save-edit-btn");
      btn.disabled=true;
      btn.textContent="å„²å­˜ä¸­...";

      const res=await window.dataSdk.update(updated);

      btn.disabled=false;
      btn.textContent="å„²å­˜";

      if(res?.isOk){
        closeEditModal();
        showSuccessMessage("âœ“ å·²æ›´æ–°è¨˜éŒ„");
        refreshAnalysisIfVisible();
      }else{
        showErrorMessage("æ›´æ–°å¤±æ•—");
      }
    });

    document.getElementById("apply-filter-btn").addEventListener("click",()=>{
      analysisFilters={
        startDate:document.getElementById("filter-start-date").value||null,
        endDate:document.getElementById("filter-end-date").value||null,
        category:document.getElementById("filter-category").value,
        minAmount:parseFloat(document.getElementById("filter-min-amount").value)||null,
        maxAmount:parseFloat(document.getElementById("filter-max-amount").value)||null
      };
      performAnalysis();
      showSuccessMessage("âœ“ ç¯©é¸å·²å¥—ç”¨");
    });

    document.getElementById("reset-filter-btn").addEventListener("click",()=>{
      initializeAnalysisFilters();
      showSuccessMessage("âœ“ å·²é‡ç½®ç‚ºç•¶æœˆè³‡æ–™");
    });

    document.getElementById("settings-btn").addEventListener("click",()=>showScreen("settings-screen"));
    document.getElementById("analysis-btn").addEventListener("click",()=>{
      initializeAnalysisFilters();
      showScreen("analysis-screen");
    });
    document.getElementById("back-from-analysis").addEventListener("click",()=>showScreen("main-screen"));
    document.getElementById("back-from-settings").addEventListener("click",()=>showScreen("main-screen"));

    document.getElementById("carrier-number-input").addEventListener("input",(e)=>{
      const v=e.target.value;
      if(v.length>0){
        document.getElementById("carrier-preview").classList.remove("hidden");
        document.getElementById("carrier-preview-text").textContent=v;
      }else{
        document.getElementById("carrier-preview").classList.add("hidden");
      }
    });

    document.getElementById("save-carrier-btn").addEventListener("click",async()=>{
      const carrierNumber=document.getElementById("carrier-number-input").value.trim();
      if(!carrierNumber){showErrorMessage("è«‹è¼¸å…¥è¼‰å…·è™Ÿç¢¼");return}
      if(!carrierNumber.startsWith("/")){showErrorMessage("è¼‰å…·è™Ÿç¢¼å¿…é ˆä»¥ / é–‹é ­");return}

      const saveBtn=document.getElementById("save-carrier-btn");
      const text=document.getElementById("save-carrier-text");
      saveBtn.disabled=true;
      text.textContent="å„²å­˜ä¸­...";

      if(carrierSettings){
        const updated={...carrierSettings,carrier_number:carrierNumber};
        const res=await window.dataSdk.update(updated);
        if(res?.isOk){showSuccessMessage("âœ“ è¼‰å…·è¨­å®šå·²æ›´æ–°")}else{showErrorMessage("æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦")}
      }else{
        const newSettings={
          id:"carrier-settings",
          carrier_number:carrierNumber,
          is_settings:true,
          is_deleted:false,
          category:"",
          amount:0,
          payment_method:"",
          carrier_used:false,
          timestamp:new Date().toISOString(),
          note:""
        };
        const res=await window.dataSdk.create(newSettings);
        if(res?.isOk){showSuccessMessage("âœ“ è¼‰å…·è¨­å®šå·²å„²å­˜")}else{showErrorMessage("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦")}
      }

      saveBtn.disabled=false;
      text.textContent="å„²å­˜è¼‰å…·è¨­å®š";
    });

    document.getElementById("quick-expense-btn").addEventListener("click",()=>{
      currentFlow={category:"",paymentMethod:"",paymentColor:"",paymentEmoji:"",carrierUsed:false,pendingAmount:0};
      renderCategoryGrid();
      showScreen("step1-screen");
    });

    document.getElementById("back-from-step1").addEventListener("click",()=>showScreen("main-screen"));
    document.getElementById("back-from-step2").addEventListener("click",()=>showScreen("step1-screen"));
    document.getElementById("back-from-step3").addEventListener("click",()=>showScreen("step2-screen"));
    document.getElementById("back-from-step4").addEventListener("click",()=>showScreen("step3-screen"));

    document.getElementById("add-category-btn").addEventListener("click",()=>{
      document.getElementById("add-category-form").classList.remove("hidden");
      document.getElementById("new-category-input").focus();
    });

    document.getElementById("cancel-category-btn").addEventListener("click",()=>{
      document.getElementById("add-category-form").classList.add("hidden");
      document.getElementById("new-category-input").value="";
    });

    document.getElementById("save-category-btn").addEventListener("click",()=>{
      const newCategory=document.getElementById("new-category-input").value.trim();
      if(newCategory && !customCategories.includes(newCategory) && !defaultCategories.includes(newCategory)){
        customCategories.push(newCategory);
        renderCategoryGrid();
      }
      document.getElementById("add-category-form").classList.add("hidden");
      document.getElementById("new-category-input").value="";
    });

    document.getElementById("skip-carrier-btn").addEventListener("click",()=>{
      currentFlow.carrierUsed=false;
      showScreen("step3-screen");
    });

    document.getElementById("continue-to-payment-btn").addEventListener("click",()=>{
      currentFlow.carrierUsed=true;
      showScreen("step3-screen");
    });

    const iosDeepLinks={
      "LINE Pay":"line://pay/generateQR",
      "Taiwan Pay":"twmpshortcut://?type=payment",
      "å…¨æ”¯ä»˜":"com.pxpay.plus://zjdja",
      "è¡—å£æ”¯ä»˜":"jkos://showQRCode",
      "æ‚ éŠä»˜":"tw.com.easycard.easycardwallet://paymentCode"
    };

    let pendingDeepLink=null;

    document.getElementById("manual-open-deeplink-btn").addEventListener("click",()=>{
      if(pendingDeepLink){window.location.href=pendingDeepLink}
    });

    document.getElementById("back-from-redirect").addEventListener("click",()=>showScreen("step3-screen"));

    document.querySelectorAll(".payment-method-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        currentFlow.paymentMethod=btn.dataset.method;
        currentFlow.paymentColor=btn.dataset.color;
        currentFlow.paymentEmoji=btn.dataset.emoji;
        document.getElementById("final-payment-display").textContent=currentFlow.paymentMethod;

        if(currentFlow.paymentMethod==="ç¾é‡‘"){
          showScreen("step4-screen");
          return;
        }

        const deeplink=iosDeepLinks[currentFlow.paymentMethod]||"";
        pendingDeepLink=deeplink;

        document.getElementById("redirect-payment-name").textContent=currentFlow.paymentMethod;
        document.getElementById("redirect-payment-icon").textContent=currentFlow.paymentEmoji;
        document.getElementById("redirect-payment-icon").style.background=currentFlow.paymentColor;
        document.getElementById("pulse-ring").style.background=currentFlow.paymentColor+"40";
        document.getElementById("deep-link-url").textContent=deeplink||"";

        showScreen("payment-redirect-screen");

        setTimeout(()=>{
          if(deeplink){
            try{window.location.href=deeplink}catch(e){}
          }
        },350);

        setTimeout(()=>{
          document.getElementById("external-app-title").textContent=currentFlow.paymentMethod;
          document.getElementById("external-payment-header").style.background=currentFlow.paymentColor;
          document.getElementById("external-icon").textContent=currentFlow.paymentEmoji;
          document.getElementById("external-icon").style.background=currentFlow.paymentColor+"20";
          document.getElementById("confirm-external-payment-btn").style.background=currentFlow.paymentColor;
          document.getElementById("external-amount-input").value="";
          showScreen("external-payment-screen");
        },1400);
      });
    });

    document.getElementById("external-amount-input").addEventListener("input",(e)=>{
      const amount=parseFloat(e.target.value)||0;
      const remaining=8520-amount;
      document.getElementById("remaining-balance").textContent=`NT$ ${remaining.toLocaleString()}`;
    });

    document.getElementById("cancel-external-payment-btn").addEventListener("click",()=>showScreen("step3-screen"));

    document.getElementById("confirm-external-payment-btn").addEventListener("click",async()=>{
      const amount=parseFloat(document.getElementById("external-amount-input").value);
      if(!amount||amount<=0){showErrorMessage("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");return}

      currentFlow.pendingAmount=amount;

      const confirmBtn=document.getElementById("confirm-external-payment-btn");
      const btnText=document.getElementById("confirm-btn-text");
      confirmBtn.disabled=true;
      btnText.textContent="è™•ç†ä¸­...";

      setTimeout(()=>{
        document.getElementById("success-amount").textContent=amount.toLocaleString();
        showScreen("payment-success-screen");

        setTimeout(async()=>{
          const record={
            id:Date.now().toString(),
            category:currentFlow.category,
            amount:currentFlow.pendingAmount,
            payment_method:currentFlow.paymentMethod,
            carrier_used:currentFlow.carrierUsed,
            timestamp:new Date().toISOString(),
            note:`é€é ${currentFlow.paymentMethod} ä»˜æ¬¾`,
            carrier_number:"",
            is_settings:false,
            is_deleted:false
          };

          const res=await window.dataSdk.create(record);
          showScreen("main-screen");
          if(res?.isOk){showSuccessMessage("âœ“ ä»˜æ¬¾æˆåŠŸï¼è¨˜éŒ„å·²è‡ªå‹•å„²å­˜")}else{showErrorMessage("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦")}

          confirmBtn.disabled=false;
          btnText.textContent="ç¢ºèªä»˜æ¬¾";
        },1200);
      },800);
    });

    document.getElementById("save-expense-btn").addEventListener("click",async()=>{
      const amount=parseFloat(document.getElementById("amount-input").value);
      const note=document.getElementById("note-input").value.trim();
      if(!amount||amount<=0){showErrorMessage("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");return}

      const saveBtn=document.getElementById("save-expense-btn");
      const btnText=document.getElementById("save-btn-text");
      saveBtn.disabled=true;
      btnText.textContent="å„²å­˜ä¸­...";

      const record={
        id:Date.now().toString(),
        category:currentFlow.category,
        amount:amount,
        payment_method:currentFlow.paymentMethod,
        carrier_used:currentFlow.carrierUsed,
        timestamp:new Date().toISOString(),
        note:note,
        carrier_number:"",
        is_settings:false,
        is_deleted:false
      };

      const res=await window.dataSdk.create(record);

      if(res?.isOk){
        document.getElementById("amount-input").value="";
        document.getElementById("note-input").value="";
        showScreen("main-screen");
        showSuccessMessage("âœ“ è¨˜éŒ„å·²å„²å­˜");
      }else{
        showErrorMessage("å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
      }

      saveBtn.disabled=false;
      btnText.textContent="å„²å­˜è¨˜éŒ„";
    });

    async function init(){
      if(window.elementSdk){
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities:()=>({recolorables:[],borderables:[],fontEditable:undefined,fontSizeable:undefined}),
          mapToEditPanelValues:(config)=>new Map([
            ["app_title",config.app_title||defaultConfig.app_title],
            ["currency_symbol",config.currency_symbol||defaultConfig.currency_symbol]
          ])
        });
      }

      if(window.dataSdk){
        const res=await window.dataSdk.init(dataHandler);
        if(!res.isOk){console.error("Failed to initialize data SDK")}
      }
    }

    init();
  </script>
</body>
</html>
